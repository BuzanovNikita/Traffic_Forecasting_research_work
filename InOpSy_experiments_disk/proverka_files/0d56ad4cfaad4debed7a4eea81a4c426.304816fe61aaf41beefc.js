"use strict";(self.webpackChunkvk=self.webpackChunkvk||[]).push([[65592],{386835:(e,t,s)=>{s.d(t,{Icon16Stars:()=>i});var i=(0,s(28178).makeIcon)("Icon16Stars","stars_16","0 0 16 16",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" id="stars_16"><path fill-rule="evenodd" d="M8.887 4.724C8.53 5.773 8.047 6.832 7.44 7.44c-.608.607-1.667 1.089-2.716 1.447a16.937 16.937 0 0 1-.801.253l-.277.08c-.381.105-.381.815 0 .92a21.173 21.173 0 0 1 1.078.332c1.049.36 2.108.84 2.716 1.448.607.608 1.089 1.667 1.447 2.715a16.942 16.942 0 0 1 .253.802l.08.277c.105.381.815.381.92 0a22.857 22.857 0 0 1 .266-.88 16.4 16.4 0 0 1 .067-.199c.358-1.048.84-2.107 1.447-2.715.608-.607 1.667-1.089 2.716-1.447a16.386 16.386 0 0 1 .8-.254l.278-.079c.381-.105.381-.815 0-.92a21.17 21.17 0 0 1-1.079-.333c-1.048-.358-2.107-.84-2.715-1.447-.607-.608-1.089-1.667-1.447-2.716a16.394 16.394 0 0 1-.254-.801 22.853 22.853 0 0 1-.079-.277c-.105-.381-.815-.381-.92 0a21.167 21.167 0 0 1-.333 1.078ZM3.53.275a.402.402 0 0 0-.762 0l-.305.917c-.2.6-.671 1.07-1.271 1.27l-.917.306a.402.402 0 0 0 0 .763l.917.306c.6.2 1.07.67 1.27 1.27l.306.918c.123.366.64.366.763 0l.306-.918c.2-.6.67-1.07 1.27-1.27l.918-.306a.402.402 0 0 0 0-.763l-.918-.305c-.6-.2-1.07-.671-1.27-1.271L3.53.275Z" /></symbol>',16,16,!1,void 0)},851594:(e,t,s)=>{s.d(t,{Icon28ArchiveCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28ArchiveCircleFillGray","archive_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="archive_circle_fill_gray_28"><linearGradient id="archive_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b1b6bd" /><stop offset="1" stop-color="#99a2ad" /></linearGradient><path fill="url(#archive_circle_fill_gray_28_a)" d="M0 14C0 6.268 6.268 0 14 0s14 6.268 14 14-6.268 14-14 14S0 21.732 0 14z" /><g fill="#fff"><path d="M6.568 8.482c-.068.255-.068.565-.068 1.185 0 .31 0 .465.034.592a1 1 0 0 0 .707.707c.127.034.282.034.592.034h12.334c.31 0 .465 0 .592-.034a1 1 0 0 0 .707-.707c.034-.127.034-.282.034-.592 0-.62 0-.93-.068-1.185a2 2 0 0 0-1.414-1.414C19.763 7 19.453 7 18.833 7H9.167c-.62 0-.93 0-1.185.068a2 2 0 0 0-1.414 1.414z" /><path fill-rule="evenodd" d="M8 14.1c0-.56 0-.84.109-1.054a1 1 0 0 1 .437-.437C8.76 12.5 9.04 12.5 9.6 12.5h8.8c.56 0 .84 0 1.054.109a1 1 0 0 1 .437.437C20 13.26 20 13.54 20 14.1v2.1c0 1.68 0 2.52-.327 3.162a3 3 0 0 1-1.311 1.311C17.72 21 16.88 21 15.2 21h-2.4c-1.68 0-2.52 0-3.162-.327a3 3 0 0 1-1.311-1.311C8 18.72 8 17.88 8 16.2zm3.5.65a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 0 1.5h-3.5a.75.75 0 0 1-.75-.75z" clip-rule="evenodd" /></g></symbol>',28,28,!1,void 0)},926128:(e,t,s)=>{s.d(t,{Icon28EducationCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28EducationCircleFillGray","education_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="education_circle_fill_gray_28"><rect width="28" height="28" fill="url(#education_circle_fill_gray_28_a)" rx="14" /><path fill="#fff" d="M19.2 14.937v1.732c0 2.116-2.328 3.831-5.2 3.831-2.873 0-5.2-1.715-5.2-3.83l-.001-1.733 4.01 2.192a2.494 2.494 0 0 0 2.23.075l.15-.075 4.01-2.192Zm-4.804-8.336 7.197 3.933a.76.76 0 0 1 .404.665H22v4.704c0 .423-.358.766-.8.766-.442 0-.8-.343-.8-.766v-3.387l-6.004 3.282a.831.831 0 0 1-.793 0l-7.2-3.933a.749.749 0 0 1 0-1.33l7.2-3.934a.831.831 0 0 1 .793 0Z" /><defs><linearGradient id="education_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop stop-color="#B1B6BD" /><stop offset="1" stop-color="#99A2AD" /></linearGradient></defs></symbol>',28,28,!1,void 0)},284069:(e,t,s)=>{s.d(t,{Icon28MessageUnreadCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28MessageUnreadCircleFillGray","message_unread_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="message_unread_circle_fill_gray_28"><linearGradient id="message_unread_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b1b6bd" /><stop offset="1" stop-color="#99a2ad" /></linearGradient><path fill="url(#message_unread_circle_fill_gray_28_a)" d="M0 14C0 6.268 6.268 0 14 0s14 6.268 14 14-6.268 14-14 14S0 21.732 0 14z" /><g fill="#fff"><path d="M19.87 12.17a3 3 0 0 1-4.09-3.935A6.77 6.77 0 0 0 13.999 8c-3.314 0-6 2.359-6 5.269 0 1.406.628 2.684 1.653 3.63a11.487 11.487 0 0 1-.404 1.688c-.055.173-.13.376-.224.606a.578.578 0 0 0 .017.475.606.606 0 0 0 .801.273l.159-.076c.152-.075.286-.145.401-.21a12 12 0 0 0 1.895-1.333c.54.14 1.11.215 1.702.215 3.314 0 6-2.359 6-5.268 0-.377-.045-.745-.13-1.099z" /><path d="M20 9.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" /></g></symbol>',28,28,!1,void 0)},19675:(e,t,s)=>{s.d(t,{Icon28NotificationCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28NotificationCircleFillGray","notification_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="notification_circle_fill_gray_28"><linearGradient id="notification_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b1b6bd" /><stop offset="1" stop-color="#99a2ad" /></linearGradient><path fill="url(#notification_circle_fill_gray_28_a)" d="M0 14C0 6.268 6.268 0 14 0s14 6.268 14 14-6.268 14-14 14S0 21.732 0 14z" /><path fill="#fff" d="M15.817 19.5a1.85 1.85 0 0 1-3.634 0zM9.5 18c-1 0-1.5-.333-1.5-1 0-1 1.5-1 1.5-2.5v-3a4.501 4.501 0 0 1 3.7-4.43V7a.8.8 0 0 1 1.6 0v.071a4.501 4.501 0 0 1 3.7 4.429v3C18.5 16 20 16 20 17c0 .667-.5 1-1.5 1z" /></symbol>',28,28,!1,void 0)},743597:(e,t,s)=>{s.d(t,{Icon28SendCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28SendCircleFillGray","send_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="send_circle_fill_gray_28"><linearGradient id="send_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b1b6bd" /><stop offset="1" stop-color="#99a2ad" /></linearGradient><path fill="url(#send_circle_fill_gray_28_a)" d="M0 14C0 6.268 6.268 0 14 0s14 6.268 14 14-6.268 14-14 14S0 21.732 0 14z" /><path fill="#fff" d="M10.16 16.628c-.458 1.298-.745 2.21-.863 2.737-.368 1.653-.637 2.026.738 1.24 1.375-.786 8.031-4.679 9.516-5.544 1.936-1.128 1.962-1.04-.104-2.237-1.573-.912-8.15-4.703-9.412-5.447-1.26-.745-1.106-.414-.738 1.24.12.533.41 1.453.875 2.761.324.915 1.079 1.586 1.992 1.772l3.843.781a.07.07 0 0 1 .052.083.068.068 0 0 1-.052.055l-3.852.78c-.916.186-1.673.86-1.996 1.779z" /></symbol>',28,28,!1,void 0)},538649:(e,t,s)=>{s.d(t,{Icon28TextCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28TextCircleFillGray","text_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="text_circle_fill_gray_28"><path fill="url(#text_circle_fill_gray_28_a)" d="M0 14C0 6.268 6.268 0 14 0s14 6.268 14 14-6.268 14-14 14S0 21.732 0 14Z" /><path fill="#fff" d="M18.42 18.97c.996 0 2.09-.51 2.535-1.379H21v.419c.045.655.357.99.944.99.617 0 1.056-.38 1.056-1.12v-4.653c0-1.645-1.331-2.727-3.376-2.727-1.65 0-2.93.602-3.301 1.577a1.204 1.204 0 0 0-.112.502c0 .503.38.853.907.853.35 0 .625-.137.863-.41.483-.64.885-1.022 1.546-1.022.818 0 1.473.602 1.473 1.364v.54l-2.142.122c-1.993.122-3.108.989-3.108 2.474 0 1.47 1.153 2.47 2.67 2.47Zm.713-1.607c-.728 0-1.152-.381-1.152-.99 0-.58.394-.953 1.204-1.014L21 15.253v.594c0 .883-.915 1.516-1.867 1.516Z" /><path fill="#fff" fill-rule="evenodd" d="M6.189 19c.621 0 .971-.297 1.189-1.01l.59-1.67.095-.32h3.853l.1.32.59 1.693c.21.697.56.987 1.22.987.684 0 1.174-.438 1.174-1.054 0-.223-.039-.423-.148-.713l-3.077-7.971C11.441 8.386 10.897 8 9.981 8c-.886 0-1.438.4-1.764 1.27l-3.062 7.963c-.1.275-.155.527-.155.713C5 18.592 5.458 19 6.189 19Zm3.745-8.803h.054l1.456 4.303H8.51l1.425-4.303Z" clip-rule="evenodd" /><defs><linearGradient id="text_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop stop-color="#B1B6BD" /><stop offset="1" stop-color="#99A2AD" /></linearGradient></defs></symbol>',28,28,!1,void 0)},951891:(e,t,s)=>{s.d(t,{Icon28UsersCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28UsersCircleFillGray","users_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="users_circle_fill_gray_28"><linearGradient id="users_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b1b6bd" /><stop offset="1" stop-color="#99a2ad" /></linearGradient><path fill="url(#users_circle_fill_gray_28_a)" d="M0 14C0 6.268 6.268 0 14 0s14 6.268 14 14-6.268 14-14 14S0 21.732 0 14z" /><path fill="#fff" d="M10.5 15c2.25 0 4.5.9 4.5 2.846v.134c0 .295-.04.447-.114.585a.773.773 0 0 1-.32.321c-.14.075-.29.114-.586.114H7.02c-.295 0-.447-.04-.585-.114a.773.773 0 0 1-.321-.32c-.075-.14-.114-.29-.114-.586v-.134C6 15.9 8.25 15 10.5 15zm7 0c2.25 0 4.5.9 4.5 2.846v.134c0 .295-.04.447-.114.585a.773.773 0 0 1-.32.321c-.14.075-.29.114-.586.114H16.6c.084-.248.13-.508.144-.797l.006-.223v-.134c0-1.069-.358-1.957-.971-2.659A7.74 7.74 0 0 1 17.5 15zm-7-6a2.25 2.25 0 1 1 0 4.5 2.25 2.25 0 0 1 0-4.5zm7 0a2.25 2.25 0 1 1 0 4.5 2.25 2.25 0 0 1 0-4.5z" /></symbol>',28,28,!1,void 0)},778816:(e,t,s)=>{s.d(t,{Icon28VolumeCircleFillGray:()=>i});var i=(0,s(28178).makeIcon)("Icon28VolumeCircleFillGray","volume_circle_fill_gray_28","0 0 28 28",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 28 28" id="volume_circle_fill_gray_28"><linearGradient id="volume_circle_fill_gray_28_a" x1="-14" x2="14" y1="14" y2="42" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b1b6bd" /><stop offset="1" stop-color="#99a2ad" /></linearGradient><path fill="url(#volume_circle_fill_gray_28_a)" d="M0 14C0 6.268 6.268 0 14 0s14 6.268 14 14-6.268 14-14 14S0 21.732 0 14z" /><path fill="#fff" fill-rule="evenodd" d="M6.923 11.5H9l3.293-3.293A1 1 0 0 1 14 8.914v10.172a1 1 0 0 1-1.707.707L9 16.5H6.923c-.669 0-.911-.07-1.156-.2-.244-.131-.436-.323-.567-.567s-.2-.487-.2-1.156v-1.154c0-.669.07-.911.2-1.156.131-.244.323-.436.567-.567.245-.13.487-.2 1.156-.2zm9.526-.788a.9.9 0 0 1 1.27.097A4.885 4.885 0 0 1 18.9 14c0 1.216-.444 2.33-1.177 3.186a.9.9 0 1 1-1.367-1.17A3.084 3.084 0 0 0 17.1 14c0-.772-.28-1.476-.747-2.018a.9.9 0 0 1 .096-1.27zm4.044-2.39a.9.9 0 1 0-1.251 1.294A6.08 6.08 0 0 1 21.1 14a6.08 6.08 0 0 1-1.859 4.384.9.9 0 0 0 1.252 1.294A7.88 7.88 0 0 0 22.9 14a7.88 7.88 0 0 0-2.407-5.677z" clip-rule="evenodd" /></symbol>',28,28,!1,void 0)},252495:()=>{},279262:()=>{},378844:(e,t,s)=>{s.d(t,{default:()=>i});const i={highlight:"CategoryGroup-module__highlight--Lukeh"}},810954:(e,t,s)=>{s.d(t,{default:()=>i});const i={icon:"SkillItem-module__icon--ubBP6",skillImage:"SkillItem-module__skillImage--dwecA"}},600292:(e,t,s)=>{s.d(t,{default:()=>i});const i={container:"GroupChatInvites-module__container--c5rBK"}},446214:(e,t,s)=>{s.d(t,{CategoriesModalBody:()=>l});var i=s(785893),a=s(140874),r=s(524100),n=s(667294);function o(e){return e.map((e=>e.items)).flat()}const l=({api:e,categories:t,selectedCategory:s,onItemClick:l,onItemView:c,onShowMoreClick:u,error:d,onError:h,reloadCategories:m})=>((0,n.useEffect)((()=>{t&&t.length&&c(o(t))}),[t]),d?(0,i.jsx)(r.ErrorBlock,{onReloadClick:m}):t?s?(0,i.jsx)(a.SkillsBlock,{api:e,categoryName:s,onItemClick:l,onItemView:c,onError:h}):(0,i.jsx)("div",{"data-testid":"marusia-skill-list",children:t.map((e=>(0,i.jsx)(a.CategoryBlock,{category:e,onShowMoreClick:u,onItemClick:e=>l(e,o(t))},e.name)))}):(0,i.jsx)(a.CategoriesSkeleton,{}))},11579:(e,t,s)=>{s.d(t,{CategoriesSkeleton:()=>g,CategoryBlock:()=>h});var i=s(785893),a=s(399639),r=s(385235),n=s(54929),o=s(219051),l=s(444972),c=s(29271),u=s(387712),d=s(415129);const h=({category:e,onShowMoreClick:t,onItemClick:s})=>{const n=(0,i.jsx)(a.Header,{aside:(0,i.jsx)(r.Link,{onClick:()=>{t(e.name,e.title)},children:c.getLang("mail_marusia_modal_show_all")}),children:e.title});return(0,i.jsx)(d.CategoryGroup,{highlight:e.is_featured,header:n,children:e.items.map((e=>(0,i.jsx)(u.SkillItem,{item:e,onClick:s},e.title)))})},m=({subtitle:e})=>(0,i.jsx)(n.SimpleCell,{before:(0,i.jsx)(o.FakeAvatar,{size:28,children:(0,i.jsx)(l.Skeleton,{circle:!0,width:28,height:28})}),hasHover:!1,hasActive:!1,subtitle:e&&(0,i.jsx)(l.Skeleton,{width:70,height:12}),children:(0,i.jsx)(l.Skeleton,{width:140,height:16})}),p=({highlight:e})=>(0,i.jsxs)(d.CategoryGroup,{highlight:!!e,children:[(0,i.jsx)(m,{}),(0,i.jsx)(m,{subtitle:!0}),(0,i.jsx)(m,{subtitle:!0}),(0,i.jsx)(m,{subtitle:!0})]}),g=()=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(p,{highlight:!0}),(0,i.jsx)(p,{}),(0,i.jsx)(p,{})]})},415129:(e,t,s)=>{s.d(t,{CategoryGroup:()=>o});var i=s(785893),a=s(378844),r=s(513724),n=s(545637);const o=({children:e,highlight:t,header:s})=>{const o=(0,i.jsx)(r.Group,{className:t?a.default.highlight:void 0,mode:t?"card":"plain",padding:t?"m":"none",header:s,separator:t?"hide":"show",children:e});return t?(0,i.jsx)(n.Div,{mode:"horizontal",style:{paddingTop:16},children:o}):o}},524100:(e,t,s)=>{s.d(t,{ErrorBlock:()=>l});var i=s(785893),a=s(635928),r=s(322421),n=s(832550),o=s(29271);const l=({onReloadClick:e})=>(0,i.jsx)(a.Placeholder,{icon:(0,i.jsx)(r.Icon56IllustrationAntenna,{}),action:(0,i.jsx)(n.Button,{mode:"tertiary",onClick:e,children:o.getLang("mail_marusia_modal_retry")}),children:o.getLang("mail_marusia_modal_error_text")})},387712:(e,t,s)=>{s.d(t,{SkillItem:()=>u,SkillSkeleton:()=>d});var i=s(785893),a=s(810954),r=s(354943),n=s(86894),o=s(219051),l=s(54929),c=s(444972);const u=({item:e,onClick:t})=>{const s="dark"===(0,n.useAppearance)()?e.icons.dark:e.icons.light;return(0,i.jsx)(n.Cell,{"data-testid":"marusia-skill-item",onClick:()=>{t(e)},before:(0,i.jsx)(o.FakeAvatar,{size:28,children:(0,i.jsx)("img",{className:a.default.skillImage,src:s,alt:e.title})}),after:(0,i.jsx)(r.Icon24ChevronCompactRight,{className:a.default.icon}),subtitle:e.subtitle,children:e.title})},d=()=>(0,i.jsx)(l.SimpleCell,{before:(0,i.jsx)(o.FakeAvatar,{size:28,children:(0,i.jsx)(c.Skeleton,{circle:!0,width:28,height:28})}),hasHover:!1,hasActive:!1,subtitle:(0,i.jsx)(c.Skeleton,{width:70,height:12}),children:(0,i.jsx)(c.Skeleton,{width:140,height:16})})},657865:(e,t,s)=>{s.d(t,{SkillsBlock:()=>o});var i=s(785893),a=s(667294),r=s(387712);const n=()=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{})]}),o=({api:e,categoryName:t,onItemClick:s,onItemView:o,onError:l})=>{const[c,u]=(0,a.useState)(null);return(0,a.useEffect)((()=>{e.skillList(t).then((e=>{u(e.result.items)})).catch(l)}),[e,t]),(0,a.useEffect)((()=>{c&&c.length&&o(c)}),[c]),(0,i.jsx)(i.Fragment,{children:c?c.map((e=>(0,i.jsx)(r.SkillItem,{item:e,onClick:e=>s(e,c)},e.title))):(0,i.jsx)(n,{})})}},140874:(e,t,s)=>{s.d(t,{CategoriesModalBody:()=>i.CategoriesModalBody,CategoriesSkeleton:()=>a.CategoriesSkeleton,CategoryBlock:()=>a.CategoryBlock,SkillsBlock:()=>r.SkillsBlock,itemToSuggest:()=>o.itemToSuggest,useCategories:()=>n.useCategories});var i=s(446214),a=s(11579),r=s(657865),n=s(997664),o=s(898791)},997664:(e,t,s)=>{s.d(t,{useCategories:()=>r});var i=s(667294);let a=null;const r=e=>{const[t,s]=(0,i.useState)(null),[r,n]=(0,i.useState)(null),[o,l]=(0,i.useState)(!1),c=()=>{a=null,n(null),l(!0)},u=()=>{l(!1),s(null),n(null),(e=>(a||(a=e.skillListCategories()),a))(e).then((e=>{s(e.result.categories)})).catch(c)};return(0,i.useEffect)((()=>{u()}),[]),{categories:t,reloadCategories:u,error:o,handleError:c,selectedCategory:r,setSelectedCategory:n}}},898791:(e,t,s)=>{s.d(t,{itemToSuggest:()=>i});const i=e=>({type:"text_suggest",callback_data:"",payload:e.subtitle,text:e.subtitle})},476091:(e,t,s)=>{s.d(t,{MarusiaButton:()=>d});var i=s(405861),a=s(533376),r=s(351305);const n="im-send-btn--marusia",o="MarusiaButtonOld--visible",l="MarusiaButtonOld--loading",c="MarusiaButtonOld__wave--active",u="MarusiaButtonOld__typing--active";class d{init({container:e}){var t,s,r,n;this.button=e,this.container=null!=(t=this.button.querySelector("._marusia_button"))?t:document.createElement("span"),this.animationContainer=null!=(s=this.container.querySelector("._marusia_animation"))?s:document.createElement("span"),this.typingContainer=null!=(r=this.container.querySelector("._marusia_typing"))?r:document.createElement("span"),this.waveContainer=null!=(n=this.container.querySelector("._marusia_wave"))?n:document.createElement("span"),this.animation=new a.LottieAnimation(this.animationContainer),this.wave=new i.Wave({min:0,max:128},2,{container:this.waveContainer,width:40,height:40,amplitude:.2,autostart:!1,cover:!0}),this.isInitialized=!0}setAnimations(e){return this.animation.setAnimations(e)}setIconState(e){if(!this.isInitialized)return;if(!this.animation.haveAnimations())return;const t=this.state;if(this.state=e,t!==this.state)switch("listen"===this.state?this.wave.start():this.wave.stop(),this.waveContainer.classList.remove(c),this.typingContainer.classList.remove(u),e){case"ready":"loading"===t?this.animation.play("load_to_mic"):"answering"===t?this.animation.play("stop_to_mic"):"listen"===t?this.animation.play("load_to_mic"):"typing"===t?this.readyShownFirstTime||(this.readyShownFirstTime=!0,this.animation.play("intro")):this.animation.play("intro");break;case"typing":this.typingContainer.classList.add(u);break;case"loading":var s;if("listen"===t)null==(s=this.animation.play("wave_to_load"))||s.then((()=>{r.playerStore.get().isPlaying||this.playLoadingLoop()}));else if("ready"===t){var i;null==(i=this.animation.play("mic_to_loader"))||i.then((()=>{this.playLoadingLoop()}))}else if("answering"===t){var a;null==(a=this.animation.play("stop_to_loader"))||a.then((()=>{this.playLoadingLoop()}))}break;case"listen":var n;if("ready"===t)null==(n=this.animation.play("mic_to_wave"))||n.then(this.showWave.bind(this));else if("answering"===t){var o;null==(o=this.animation.play("stop_to_wave"))||o.then(this.showWave.bind(this))}else if("loading"===t){var l;null==(l=this.animation.play("mic_to_wave"))||l.then(this.showWave.bind(this))}break;case"answering":"loading"===t?this.animation.play("load_to_stop"):"listen"===t?this.animation.play("wave_to_stop"):"ready"===t&&this.animation.play("load_to_stop");break;case"error":"ready"===t&&this.animation.play("mic_to_error")}}hide(){this.isInitialized&&(this.button.classList.remove(n),this.container.classList.remove(o))}show(){this.isInitialized&&(this.button.classList.add(n),this.container.classList.add(o))}showPreload(){this.container.classList.add(l)}hidePreload(){this.container.classList.remove(l)}updateWave(e){this.wave.update(e)}dispose(){this.isInitialized&&(this.hide(),this.wave.dispose(),this.animationContainer.innerHTML="",this.waveContainer.innerHTML="")}showWave(){"listen"===this.state&&this.waveContainer.classList.add(c)}playLoadingLoop(){"loading"===this.state&&this.animation.play("load_loop",{loop:!0})}constructor(){this.readyShownFirstTime=!1,this.isInitialized=!1}}},666236:(e,t,s)=>{s.d(t,{MarusiaStatCollector:()=>n});var i=s(262339),a=s(567161),r=s(1483);class n{logPerformance(e){return this.performanceCollector.logEvent(e)}logConversationView(e){return this.conversationViewCollector.logEvent(e)}logConversationClick(e){return this.conversationClickCollector.logEvent(e)}constructor(){this.performanceCollector=new i.MarusiaPerformanceActionStatCollector,this.conversationViewCollector=new a.MarusiaConversationViewStatsCollector,this.conversationClickCollector=new r.MarusiaConversationClickStatsCollector}}},78024:(e,t,s)=>{s.d(t,{SuggestManager:()=>l});var i=s(29271),a=s(661893);const r="MarusiaSuggestsOld--visible",n="MarusiaSuggestsOld__item";function o(e){let t="";return"text_suggest"===e.type&&(t=e.text),"event_suggest"===e.type&&(t=e.text),"url_suggest"===e.type&&(t=e.text),(0,a.replaceSpecialPhrases)(t)}class l{init({container:e,onSuggestClick:t,onSuggestListUpdate:s}){var i;this.canvas=document.createElement("canvas"),this.container=e,this.suggestList=null!=(i=e.querySelector("._marusia_suggest_list"))?i:document.createElement("div"),this.onSuggestClick=t,this.onSuggestListUpdate=s,this.suggestList.addEventListener("wheel",(e=>((e,t)=>{e.scrollLeft+=t.deltaY})(this.suggestList,e))),this.isInitialized=!0}toggleVisibility(e){this.container.classList.toggle(r,e)}show(){this.isInitialized&&this.container.classList.add(r)}hide(){this.isInitialized&&this.container.classList.remove(r)}clearSuggests(){var e;this.suggestList.innerHTML="",null==(e=this.onSuggestListUpdate)||e.call(this,[])}update(e,t=!1){var s;this.currentCommands=e,this.toggleVisibility(!!e.length),this.clearSuggests(),(t?e:this.short(e)).forEach((e=>{const t=this.createSuggestItem(e);this.suggestList.appendChild(t)})),null==(s=this.onSuggestListUpdate)||s.call(this,e)}unmount(){this.isInitialized&&(this.hide(),this.suggestList.innerHTML="")}getSuggestWidthPx(e){return this.getTextWidth(o(e))+34}getTextWidth(e){const t=this.canvas.getContext("2d");if(!t)return 7*e.length;t.font=this.getContainerFont();return t.measureText(e).width}getContainerFont(){const e=getComputedStyle(this.suggestList);return`${e.getPropertyValue("font-weight")} ${e.getPropertyValue("font-size")} ${e.getPropertyValue("font-family")}`}short(e){let t=this.suggestList.offsetWidth,s=3,i=[],a=!0;return e.forEach((e=>{if(0===s)return void(a=!1);const r=this.getSuggestWidthPx(e);if(t-=r,t>=0)i.push(e);else{if(s-=1,0===s)return void(a=!1);t=1===s?500-r-118:500-r,t>=0&&i.push(e)}})),a||i.push({type:"more"}),i}createSuggestItem(e){if("more"===e.type)return this.createMoreItem();const t=document.createElement("div");return t.className=n,t.innerHTML=o(e),t.onclick=()=>{this.onSuggestClick(e,this.instanceId,this.currentCommands,"suggests")},t}createMoreItem(){const e=document.createElement("div");return e.className=n,e.innerHTML=i.getLang("mail_marusia_suggest_show_more"),e.onclick=()=>{this.update(this.currentCommands,!0)},e}constructor(e){this.instanceId=e,this.currentCommands=[],this.isInitialized=!1}}},159767:(e,t,s)=>{s.d(t,{TtsPlayer:()=>l});var i=s(11010),a=s(220681),r=s(167977),n=s(391199),o=s(351305);class l{init(){!1===this.isInitialized&&(this.player.src=a.SILENCE,this.player.play().catch((()=>{})),this.isInitialized=!0)}prepareSoundPlay(){this.soundPlayer.src=a.SILENCE,this.soundPlayer.play().catch((()=>{}))}prepareTtsPlay(){this.interruptCurrentAudio(),this.player.src=a.SILENCE,this.player.play().catch((()=>{}))}playSound(e){this.soundPlayer.src=e,this.soundPlayer.play().catch((()=>{}))}stop(e=!0){e&&this.restoreMediaVolume(),this.interruptCurrentAudio(),this.player.pause(),o.playerStore.setIsPlaying(!1)}play(e,t){var s=this;return(0,i._)((function*(){const i=yield s.getTtsUrl(e,t);return o.playerStore.setIsPlaying(!0),new Promise(((e,t)=>{s.player.src=i,s.reduceMediaVolume(),s.player.play().catch((()=>{})),s.interruptCurrentAudio=()=>t(new Error(n.MarusiaError.USER_INTERRUPT)),s.player.onended=()=>{o.playerStore.setIsPlaying(!1),s.restoreMediaVolume(),s.player.onended=null,e()}}))}))()}reduceMediaVolume(){null===this.prevVolume&&(this.prevVolume=this.audioPlayer.getVolume()),this.audioPlayer.setVolume(.01)}restoreMediaVolume(){null!==this.prevVolume&&(this.audioPlayer.setVolume(this.prevVolume),this.prevVolume=null)}getTtsUrl(e,t){var s=this;return(0,i._)((function*(){let i="";switch(t.type){case"tts":i=yield s.getStreamUrl(e,t.stream_id);break;case"sound":i=t.url}return i}))()}getStreamUrl(e,t){var s=this;return(0,i._)((function*(){const i=yield s.api.getApiHost(),a=yield(0,r.getSession)(s.api),n=s.api.generateDeviceId(),o={session_id:a.session_id,device_id:n,stream_id:t,phrase_id:e},l=new URLSearchParams(o).toString();return`${i.server_url}/stream?${l}`}))()}constructor({audioPlayer:e,api:t}){this.isInitialized=!1,this.prevVolume=null,this.interruptCurrentAudio=()=>{},this.player=new Audio,this.soundPlayer=new Audio,this.audioPlayer=e,this.api=t}}},351305:(e,t,s)=>{s.d(t,{playerStore:()=>i});const i=(()=>{let e=0;const t={isPlaying:!1};let s=[];const i=e=>{s.forEach((t=>{t.cb(e)}))};return{get:()=>t,set:(e,s)=>{t[e]=s,i(t)},setIsPlaying:e=>{t.isPlaying=e,i(t)},subscribe:t=>{const i=e++;return s.push({id:i,cb:t}),()=>{s=s.filter((e=>e.id!==i))}}}})()},533376:(e,t,s)=>{s.d(t,{LottieAnimation:()=>r});var i=s(11010),a=s(434788);class r{haveAnimations(){return!!this.animations}setAnimations(e){var t=this;return(0,i._)((function*(){const i=yield Promise.all([s.e(38288),s.e(55489)]).then(s.bind(s,682832)).then((e=>e.lottie));t.animations=Object.entries(e).reduce(((e,[s,r])=>(0,a._)({},e,{[s]:e=>{const n=document.createElement("span");t.targetEl.appendChild(n);const o={container:n,animationData:r,renderer:"svg",name:s,autoplay:!1,loop:!1,rendererSettings:{viewBoxOnly:!0}};return i.loadAnimation((0,a._)({},o,e))}})),{})}))()}play(e,t){var s;if(null==(s=this.animations)?void 0:s[e])return new Promise((s=>{if(!this.animations)return void s();const i=this.animations[e](t);i.addEventListener("complete",(()=>{s()})),i.addEventListener("DOMLoaded",(()=>{setTimeout((()=>{if(this.currentAnimation){var e;const t=this.currentAnimation.wrapper;this.currentAnimation.destroy(),null==(e=t.parentNode)||e.removeChild(t)}this.currentAnimation=i}),50)})),i.play()}))}constructor(e){this.animations=null,this.targetEl=e}}},269425:(e,t,s)=>{s.d(t,{constructPlayerAudio:()=>u,extractPlaylistCommands:()=>v,getAudioList:()=>f,getCommandsToAutoplay:()=>y,getFullIdFromTuple:()=>p,getHashesForAudios:()=>l,getVoiceAssistantData:()=>d,isAudioAttach:()=>m});var i=s(11010),a=s(434788),r=s(182525),n=s(285853);const o="marusia_playlist_audio";function l(e,t){return c.apply(this,arguments)}function c(){return(c=(0,i._)((function*(e,t){const s=t.map((e=>`${e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_OWNER_ID]}_${e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]}_${e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_ACCESS_KEY]}`)).join(","),i=yield e.reloadAudios(s).catch((()=>null));return i?(i.forEach((e=>{const s=t.find((t=>t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]===e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]));s&&(e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_EXTRA]=s[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_EXTRA])})),i):null}))).apply(this,arguments)}function u(e,t,s){var i;const a=function(e){var t,s,i,a;if(e.coverUrl)return`${e.coverUrl},${e.coverUrl}`;if(e.cover_url)return`${e.cover_url},${e.cover_url}`;if((null==(s=e.album)||null==(t=s.thumb)?void 0:t.photo_68)&&(null==(a=e.album)||null==(i=a.thumb)?void 0:i.photo_135)){return`${e.album.thumb.photo_68},${e.album.thumb.photo_135}`}return""}(e),l=!!e.album&&[e.album.owner_id,e.album.id,e.album.access_key],c=function(e,t){switch(e){case n.MarusiaMediaType.podcast:return{podcast:!0,fave:!1,private:!1};case n.MarusiaMediaType.tale:case n.MarusiaMediaType.books:return{voiceAssistant:t,marusiaTale:!0};case n.MarusiaMediaType.radio:return{voiceAssistant:t,radio:!0,externalStream:!0};default:return{voiceAssistant:t}}}(t,s),u=new Array(27);let d=e.title;var h;let m=null!=(h=e.artist)?h:"Marusia";var p,g,_,v,y,f,E;return t===n.MarusiaMediaType.radio&&(d=`${e.artist} ${e.title}`,m=""),u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]=null!=(p=e.id)?p:0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_OWNER_ID]=null!=(g=e.owner_id)?g:0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_URL]=e.url,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_TITLE]=d,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_PERFORMER]=m,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_DURATION]=null!=(_=e.duration)?_:0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ALBUM_ID]=null!=(v=null==(i=e.album)?void 0:i.id)?v:0,u[7]=0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_AUTHOR_LINK]="",u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_LYRICS]=0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_FLAGS]=0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_CONTEXT]=t===n.MarusiaMediaType.tale||t===n.MarusiaMediaType.books?"":"im",u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_EXTRA]=JSON.stringify(c),u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_HASHES]="",u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_COVER_URL]=a,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ADS]=null!=(y=e.ads)?y:{},u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_SUBTITLE]="",u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_MAIN_ARTISTS]="",u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_FEAT_ARTISTS]="",u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ALBUM]=l,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_TRACK_CODE]=null!=(f=e.track_code)?f:"",u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_RESTRICTION]=0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ALBUM_PART]=0,u[23]=!0,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_ACCESS_KEY]=null!=(E=e.access_key)?E:o,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_CHART_INFO_INDEX]=!1,u[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_TRACK_PAGE_ID]="",u}function d(e,t){let s;const i=h(e),a=t.find((e=>{var t;return null==(t=e.attaches)?void 0:t.find((e=>e.id===i))}));if(a){var r;const e=null==(r=a.attaches)?void 0:r.findIndex((e=>e.id===i));if(-1!==e){var n;const t=null==(n=a.kludges)?void 0:n[`attach${e+1}_voice_assistant`];try{s=JSON.parse(t)}catch(e){}}}return s}function h(e){var t,s;return(null!=(t=e.meta.owner_id)?t:0)+"_"+(null!=(s=e.meta.id)?s:0)}function m(e){return"type"in e&&("audio"===e.type||"podcast"===e.type)}function p(e){var t,s;return`${null!=(t=e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_OWNER_ID])?t:0}_${null!=(s=e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID])?s:0}`}function g(e){return"media"===e.type||"playlist"===e.type}function _(e){return Promise.all(e.map(((t,s)=>function(e,t,s){return 0===e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_DURATION]?new Promise((i=>{const a=new Audio(e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_URL]);a.addEventListener("loadedmetadata",(()=>{s[t][r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_DURATION]=a.duration,i()})),setTimeout(i,5e3)})):Promise.resolve()}(t,s,e))))}function v(e){if(!e.length)return[];const t=[];return e.filter(g).forEach((e=>{"media"===e.type&&t.push(e),"playlist"===e.type&&e.tracks.forEach((e=>{t.push((0,a._)({},e,{type:"media"}))}))})),t}function y(e,t){var s;const i=t.map((e=>null!=(s=e.attaches)?s:[])).flat().filter(m);if(!e.length)return[];const a=i.map((e=>e.id));let r=v(e);return r=r.filter((e=>a.includes(h(e)))),r}function f(e,t){return E.apply(this,arguments)}function E(){return(E=(0,i._)((function*(e,t){let s=t[e];const i=t.filter(((t,s)=>s<e)),a=s.media_type;if(i.filter((e=>"media"===e.type&&e.media_type===a)).length)return;const r=t.filter((e=>"media"===e.type&&e.media_type===a)).map((e=>{var t;return u(e.meta,a,{source:null==(t=e.meta)?void 0:t.source})}));return yield _(r),r}))).apply(this,arguments)}},938141:(e,t,s)=>{s.d(t,{processCommandNeedMoreVkPermissions:()=>a});var i=s(11010);function a(e,t,s){return r.apply(this,arguments)}function r(){return(r=(0,i._)((function*(e,t,s){s(yield e.upgradeToken(t))}))).apply(this,arguments)}},465889:(e,t,s)=>{s.d(t,{MARUSIA_HELP_BUTTON_CLASS:()=>i});const i="_im_marusia_help"},727745:(e,t,s)=>{s.d(t,{MarusiaSharedSdk:()=>f});var i=s(11010),a=s(571039),r=s(301230),n=s(391199),o=s(39460),l=s(589100),c=s(159767),u=s(351305),d=s(167977),h=s(661893),m=s(285853),p=s(974861),g=s(367431),_=s(839470),v=s(666236);const y=(0,g.makeSharedState)("marusia-sdk",(()=>({vkcom:()=>{},mvk:()=>{},fastchat:()=>{}})),{version:0});class f{onPhraseUpdate(e){var t,s;null==(t=(s=this.eventCallbacks).phrase_update)||t.call(s,e.text_so_far||"...")}generateId(){return this.platform.entry+this._messageId++}enqueueCommand(e){this.processCommandsQueue.push(e)}isQueued(e){return!!this.processCommandsQueue.find((t=>t.id===e))}processCommandsFromQueue(e){if(0!==this.processCommandsQueue.length&&this.processCommandsQueue[0].id===e){const e=this.processCommandsQueue.shift();if(!e)return;if(this.isHidden)return;e.cb()}}clearQueue(){this.processCommandsQueue=[]}sendMessage(e,t,s,i){var a,r;null==(a=(r=this.eventCallbacks).send_message)||a.call(r,{text:e,payload:{communication_type:t,voice_assistant:{support_process_commands_by_ids:!0,id:s.id}},instanceId:i}),this.enqueueCommand(s)}onPhraseFinish(e,t,s){var i,a;const r=()=>{this.processCommands(t,s.result.commands,s.result.controls).then((()=>{var t;this.setMarusiaState("ready");let i=!0;if(s.result.commands.length){"listen"===s.result.commands[s.result.commands.length-1].type&&(i=!1,this.onClick(e))}s.result.controls.some((e=>e.type===p.ControlType.CONTROL_TYPE_VOLUME))&&(i=!1),i&&(null==(t=this.ttsPlayer)||t.restoreMediaVolume())})).catch((e=>{this.onError(e)}))};var o,l;if(null===s.result.asr_text)return this.clearTextInput(),null==(o=(l=this.eventCallbacks).phrase_finish)||o.call(l,""),void r();null==(i=(a=this.eventCallbacks).phrase_finish)||i.call(a,s.result.asr_text);const c={id:this.generateId(),cb:r};this.sendMessage(s.result.asr_text,n.CommunicationType.button,c,e),this.isRecording=!1}onStatusUpdate(e){var t;switch(this.log("textSoFar",e,null==(t=Object.entries(l.TextSoFarStatus).find((t=>t[1]===e)))?void 0:t[0]),e){case l.TextSoFarStatus.INIT:this.isDisabled=!0,this.setMarusiaState("loading");break;case l.TextSoFarStatus.MEDIA_STREAM_ACQUIRED:var s,i,a;if(this.staticStorage)null==(a=this.ttsPlayer)||a.playSound(this.staticStorage.sounds.sound_start);null==(s=(i=this.eventCallbacks).phrase_start)||s.call(i,"...");break;case l.TextSoFarStatus.PHRASE_CREATED:var r;null==(r=this.textSoFar)||r.start(),this.isDisabled=!1,this.setMarusiaState("listen"),this.isRecording=!0;break;case l.TextSoFarStatus.API_ERROR:var n,o;this.isDisabled=!1,this.setMarusiaState("ready"),null==(n=(o=this.eventCallbacks).phrase_finish)||n.call(o,"");break;case l.TextSoFarStatus.GRACE_STOP:case l.TextSoFarStatus.PRE_RESULT:var c;if(this.isDisabled=!0,this.staticStorage)null==(c=this.ttsPlayer)||c.playSound(this.staticStorage.sounds.sound_end);this.setMarusiaState("loading"),this.isRecording=!1;break;case l.TextSoFarStatus.NOTHING:var u,d,h;this.isDisabled=!1,this.setMarusiaState("ready"),this.isRecording=!1,null==(u=(d=this.eventCallbacks).phrase_finish)||u.call(d,""),null==(h=this.ttsPlayer)||h.restoreMediaVolume();break;case l.TextSoFarStatus.INTERRUPT:var m,p;this.isDisabled=!1,this.setMarusiaState("ready"),this.isRecording=!1,null==(m=(p=this.eventCallbacks).phrase_finish)||m.call(p,"");break;case l.TextSoFarStatus.SUCCESS:this.isDisabled=!1;break;case l.TextSoFarStatus.ERROR:var g,_;this.isDisabled=!1,this.setMarusiaState("ready"),null==(g=(_=this.eventCallbacks).phrase_finish)||g.call(_,"")}}onAudioProcess(e){var t,s,i;null==(t=this.marusiaButton)||t.updateWave(e),null==(s=(i=this.eventCallbacks).wave_update)||s.call(i,e)}onError(e){var t,s;switch(this.log("onError",e,e.message),e.message){case n.MarusiaError.BACKEND_COMMAND_TIMEOUT:this.setMarusiaState("error");break;case n.MarusiaError.HIDDEN:this.setMarusiaState("ready");break;case n.MarusiaError.USER_INTERRUPT:var i;null==(i=this.ttsPlayer)||i.restoreMediaVolume(),this.setMarusiaState("ready");break;case n.MarusiaError.ATTACH_LOAD_TIMEOUT:break;default:this.log("unknown error",e,e.name,e.message)}null==(t=(s=this.eventCallbacks).error)||t.call(s,e.message)}getMarusiaSessionId(){return(0,d.getSession)(this.api)}loadStatic(){var e=this;return(0,i._)((function*(){const t=yield e.api.getWebStatic(),s=[...Object.entries(t.animations)],i=yield Promise.all(s.map((e=>fetch(e[1]).then((e=>e.json()))))),a={sounds:t.sounds,animations:{}};return s.forEach(((e,s)=>{const r=e[0],n=i[s],o=t.images.marusia_bg.split("/");n.assets[0].u=o.slice(0,-1).join("/")+"/",n.assets[0].p=o[o.length-1],a.animations[r]=n})),a}))()}preload(){var e=this;return(0,i._)((function*(){var t,s;const i=yield Promise.all([e.loadStatic(),e.getMarusiaSessionId()]);return null==(t=(s=e.eventCallbacks).session_create)||t.call(s),i}))()}waitForBackendCommand(e){return new Promise(((t,s)=>{const i=e.phraseId+e.commandIds.flat().join("-"),a=setTimeout((()=>{this.backendCommandsQueue=this.backendCommandsQueue.filter((e=>e.id!==i)),s(n.MarusiaError.BACKEND_COMMAND_TIMEOUT)}),this.BACKEND_COMMAND_TIMEOUT);this.backendCommandsQueue.push({id:i,callback:()=>{var s;clearTimeout(a);const r=this.backendCommandsQueue.find((e=>e.id===i));var n;this.backendCommandsQueue=this.backendCommandsQueue.filter((e=>e.id!==i)),this.statCollector.logPerformance({key:"backend_command_processing_time",value:Date.now()-e.timeStart,entry_point:this.platform.entry}),t([...null!=(n=null==(s=r)?void 0:s.events)?n:[]])},events:[],signature:e})}))}processBackendCommands(e,t){return this.api.processBackendCommands(e,t),this.waitForBackendCommand({phraseId:e,commandIds:[...t],timeStart:Date.now()})}failIfHidden(){if(this.isHidden)throw new Error(n.MarusiaError.HIDDEN)}interruptProcessingCommands(){Object.keys(this.processingCommands).forEach((e=>{this.processingCommands[e]=!0}))}failIfInterrupted(e){if(this.processingCommands[e])throw new Error(n.MarusiaError.USER_INTERRUPT)}needNewChunk(e){return(0,h.isSuggestCommand)(e)||"playlist"===e.type||"media"===e.type}processCommands(e,t,s){var a=this;return(0,i._)((function*(){if(a.processingCommands[e]=!1,a.log(`[${e}] commands`,t),!a.api)return;let i=[],r=[];0===t.filter(h.isSuggestCommand).length&&a.clearSuggests();for(let s=0;s<t.length;s++){const n=t[s],o=s+1<t.length?t[s+1]:null,l=yield a.api.isBackendCommand(n),c=!!o&&(yield a.api.isBackendCommand(o));if(a.failIfHidden(),a.needNewChunk(n)&&r.length&&(i.push(r),r=[]),l){if(r.push(s),o&&(c||a.needNewChunk(o)))continue;i.push(r),r=[]}else switch(a.log(`[${e}] exec`,n.type,n),n.type){case"tts":case"sound":yield a.processTtsCommand(e,n);break;case"media":const i=[m.MarusiaMediaType.tale,m.MarusiaMediaType.music,m.MarusiaMediaType.books,m.MarusiaMediaType.radio];a.audioPlayer&&i.includes(n.media_type)&&(yield a.commands.processMedia(a.audioPlayer,s,t,e));break;case"playlist":a.audioPlayer&&a.commands.processPlaylist(a.audioPlayer,n,e);break;case"event_suggest":case"text_suggest":case"url_suggest":a.processSuggestCommands(t,s);break;case"portal_deeplink":a.commands.processPortalDeeplink(n);break;case"need_more_vk_permissions":a.commands.processNeedMoreVkPermissions(a.api,n,(()=>{if("text"in n.repeat_data)a.processTextPhrase(n.repeat_data.text);else{const e={};try{e.callback_data=JSON.parse(n.repeat_data.callback_data)}catch(e){a.log(e)}a.onMarusiaEvent(n.repeat_data.event,e)}})).catch((e=>{a.log("NeedMoreVkPermissions error",e)}));break;case"call_start":a.commands.processCallStart(n);break;case"send_event_data":"drop"===n.on_interrupt&&a.failIfInterrupted(e),a.processSendEventDataCommand(n);break;case"delay":yield new Promise((e=>setTimeout(e,n.length)))}if(i.length){if(o&&(c||a.needNewChunk(o)))continue;const s=yield a.processBackendCommands(e,i);a.log(`[${e}] GOT BACKEND CMD`,i,t.filter(((e,t)=>i.flat().includes(t)))),a.failIfHidden();const n=t.filter(((e,t)=>i.flat().includes(t))).filter((e=>"media"===e.type||"playlist"===e.type));a.audioPlayer&&(yield a.commands.autoPlayMediaAttaches(a.api,a.audioPlayer,n,s,e)),i=[],r=[]}}s.forEach((e=>a.audioPlayer&&a.commands.executeControl(a.audioPlayer,e)))}))()}isSuggestCommands(e){return e.every((e=>"event_suggest"===e.type||"text_suggest"===e.type||"url_suggest"===e.type))}getSuggests(e){var t=this;return(0,i._)((function*(){const s=yield t.api.getSuggests(e);var i,a,r;(t.failIfHidden(),t.isSuggestCommands(s.items))&&(null==(i=t.suggestManager)||i.update(s.items,t.suggestsFlat),null==(a=(r=t.eventCallbacks).suggest_update)||a.call(r,s.items),s.items.length&&t.statCollector.logConversationView({suggest_item:{suggests:s.items.map((e=>({text:e.text})))},type:"suggests"}))}))()}clearSuggests(){var e,t,s,i;null==(e=this.suggestManager)||e.clearSuggests(),null==(t=(s=this.eventCallbacks).suggest_update)||t.call(s,[]),null==(i=this.suggestManager)||i.hide()}onSuggestClick(e,t,s,r){var o=this;return(0,i._)((function*(){if(s&&o.statCollector.logConversationClick({type:null!=r?r:"hint",suggest_item:{action_index:s.findIndex((t=>t.text===e.text))+1,suggests:s.map((e=>({text:e.text})))}}),"url_suggest"===e.type)return void window.open((0,a.wrapAwayIfExternal)(e.url,!0),"_blank");o.clearSuggests(),o.stopListening();const i=(0,h.getSuggestContentForApi)(e),l={};try{l.callback_data=JSON.parse(e.callback_data)}catch(e){o.log(e)}const c={id:o.generateId(),cb:()=>{"event_suggest"===e.type?o.onMarusiaEvent(e.event,l):o.processTextPhrase(i,l)}};o.sendMessage((0,h.replaceSpecialPhrases)(i),n.CommunicationType.suggest,c,t)}))()}processSuggestCommands(e,t){var s,i,a;const r=e[t],n=e.filter(((e,s)=>s>t)).filter((e=>(0,h.isSuggestCommand)(e)));if(!(0,h.isSuggestCommand)(r))return;if(n.length)return;const o=e.filter(h.isSuggestCommand);null==(s=this.suggestManager)||s.update(o,this.suggestsFlat),o.length&&this.statCollector.logConversationView({suggest_item:{suggests:o.map((e=>({text:e.text})))},type:"suggests"}),null==(i=(a=this.eventCallbacks).suggest_update)||i.call(a,o)}processTtsCommand(e,t){var s=this;return(0,i._)((function*(){return s.ttsPlayer?s.ttsPlayer.play(e,t):Promise.resolve()}))()}handleOutboundMessage(e){var t,s;this.interruptProcessingCommands();const i=JSON.parse(null!=(s=null==(t=e.kludges)?void 0:t.payload)?s:"null");if(i)switch(i.communication_type){case n.CommunicationType.button:case n.CommunicationType.suggest:if(this.isQueued(i.voice_assistant.id)){if(e.local)return void this.setMarusiaState("loading");this.processCommandsFromQueue(i.voice_assistant.id)}break;case n.CommunicationType.text:e.local?(this.audioPlayer&&!this.audioPlayer.isPlaying()&&this.audioPlayer.preparePlay(),this.setMarusiaState("loading"),this.outboundMessageIds.push(e.randomId)):null!==e.randomId&&this.outboundMessageIds.includes(e.randomId)&&(this.outboundMessageIds=this.outboundMessageIds.filter((t=>t!==e.randomId)),this.processTextPhrase(e.text))}}handleInboundMessage(e){var t,s,i;const a=JSON.parse(null!=(i=null==(t=e.kludges)?void 0:t.payload)?i:"null");if(!a||!a.voice_assistant)return;(null==(s=a.voice_assistant.commands)?void 0:s.length)&&this.processPayloadCommands(a.voice_assistant.commands);const r=this.backendCommandsQueue.find((e=>{var t;return e.signature.phraseId===(null==(t=a.voice_assistant)?void 0:t.phrase_id)}));if(!r)return;const n=r.signature.phraseId,o=r.signature.commandIds[0];(0,h.isPayloadForCommand)(a,{phraseId:n,commandIds:o})&&(r.signature.commandIds.shift(),r.events.push(e),0===r.signature.commandIds.length&&r.callback())}handleSendStartSession(e,t,s){(0,_.partConfigEnabled)("marusia_send_start_session")&&(e||t||s||this.api.sendStartSessionEvent())}hasDeeplinkParams(){const e=new URLSearchParams(window.location.search),t=e.get("text"),s=e.get("text_data"),i=e.get("event_name"),a=e.get("event_data");return!!(t||s||i||a)}handleDeeplink(){const e=new URLSearchParams(window.location.search),t=e.get("event_name"),s=e.get("event_data");if(t){const e=s?(0,h.parseBase64JSON)(s):null;this.onMarusiaEvent(t,{client_data:e})}}onMarusiaEvent(e,t){var s=this;return(0,i._)((function*(){var i;const a=yield s.api.phraseCreateEvent(e,t,null==(i=s.audioPlayer)?void 0:i.getPlayerData());s.failIfHidden(),a?"error"in a?s.onError(new Error(a.error)):yield s.processCommands(a.result.phrase_id,a.result.phrase_result.commands,a.result.phrase_result.controls).then((()=>{s.setMarusiaState("ready")})).catch((e=>{s.onError(e)})):s.setMarusiaState("error")}))()}processTextPhrase(e,t){var s=this;return(0,i._)((function*(){var i;s.setMarusiaState("loading");const a=yield s.api.phraseCreateText(e,t,null==(i=s.audioPlayer)?void 0:i.getPlayerData()).catch((()=>null));s.failIfHidden(),a?s.processCommands(a.result.phrase_id,a.result.phrase_result.commands,a.result.phrase_result.controls).then((()=>{s.setMarusiaState("ready")})).catch((e=>{s.onError(e)})):s.setMarusiaState("error")}))()}handleTextInput(e){const t=this.getTextFromInputEvent(e),s=r.browser.safari?"\n"!==t&&!!t:!!t;this.setMarusiaState(s?"typing":"ready")}textInputHaveText(){return!!this.textInput&&!!this.textInput.innerText}processSendEventDataCommand(e){const t={client_data:{}};try{t.client_data.send_event_data=JSON.parse(e.callback_data)}catch(e){}this.onMarusiaEvent(e.event,t)}processPayloadCommands(e){this.log("payload commands",e);for(let t=0;t<e.length;t++){const s=e[t];switch(s.type){case"vk_get_data_event":this.processSendEventDataCommand(s);break;case"event_suggest":case"text_suggest":case"url_suggest":this.processSuggestCommands(e,t)}}}init(e){var t=this;return(0,i._)((function*(){var s,i,a;t.log("init",t,e,t.isInitialized),t.showCount+=1,null==(s=t.suggestManager)||s.show();let r=e.draftText;"..."===r&&(t.clearTextInput(),r=""),t.show(!!r);const n=yield t.api.getLastMessageCommands().catch((()=>null));if(n&&n.length&&!e.needOnboarding&&t.processPayloadCommands(n),null!==n&&0!==n.length||e.needOnboarding||t.getSuggests(!!e.unreadMessages).catch((()=>{})),t.isInitialized||t.isLoading)return;t.handleSendStartSession(!!e.unreadMessages,e.needOnboarding,t.hasDeeplinkParams());const o=Date.now();var l;t.setTextValue=e.setTextValue,t.onHelpClick=e=>{t.showSkillListModal(t.api,t.statCollector,((s,i)=>{t.onSuggestClick(s,e,i)}))},t.isLoading=!0,t.textInput=null!=(l=e.textInput)?l:null,t.textInput&&(t.textInput.addEventListener("input",t.handleTextInput.bind(t)),t.isHidden||(0,h.disableMarusiaTextInput)(t.textInput)),e.iconContainer&&t.marusiaButton&&(t.marusiaButton.init({container:e.iconContainer}),t.isHidden||t.marusiaButton.show(),t.marusiaButton.showPreload());const[d,m]=yield t.preload();var p;(t.sessionId=m.session_id,yield null==(i=t.marusiaButton)?void 0:i.setAnimations(d.animations),t.staticStorage=d,t.ttsPlayer=new c.TtsPlayer({audioPlayer:t.audioPlayer,api:t.api}),t.ttsPlayer.init(),t.unsubscribeFromPlayerStore=u.playerStore.subscribe((e=>{e.isPlaying?(t.isSpeaking=!0,t.setMarusiaState("answering")):(t.isSpeaking=!1,t.setMarusiaState("ready"))})),null==(a=t.marusiaButton)||a.hidePreload(),t.textInput&&!t.isHidden&&(0,h.enableMarusiaTextInput)(t.textInput),e.needOnboarding)&&(null==(p=t.api)||p.getOnboarding().then((s=>{s.is_sent||t.getSuggests(!!e.unreadMessages).catch((()=>{}))})));t.isInitialized=!0,t.isLoading=!1,t.statCollector.logPerformance({key:"sdk_init_time",value:Date.now()-o,entry_point:t.platform.entry}),e.suggestContainer&&t.suggestManager&&(t.suggestManager.init({container:e.suggestContainer,onSuggestClick:t.onSuggestClick.bind(t),onSuggestListUpdate:t.eventCallbacks.suggest_update}),t.getSuggests(!!e.unreadMessages).catch((()=>{}))),t.setMarusiaState(t.textInputHaveText()?"typing":"ready"),t.handleDeeplink()}))()}show(e){var t;this.isHidden=!1,this.setMarusiaState(e?"typing":"ready"),null==(t=this.marusiaButton)||t.show(),this.platform.show(),this.textInput&&(this.isLoading?(0,h.disableMarusiaTextInput)(this.textInput):(0,h.enableMarusiaTextInput)(this.textInput))}hide(){var e,t;this.isHidden=!0,this.setMarusiaState("ready"),null==(e=this.marusiaButton)||e.hide(),null==(t=this.suggestManager)||t.hide(),this.platform.hide(),this.textInput&&(0,h.enableMarusiaTextInput)(this.textInput),this.clearQueue()}canSentMessage(){return"loading"!==this.marusiaState&&("listen"!==this.marusiaState&&("answering"!==this.marusiaState&&!this.isLoading))}onAddMessage(e){this.log(`onAddMessage skip: ${this.isHidden}`,e);try{if(this.isHidden)return;e.forEach((e=>{e.isOutbound?this.handleOutboundMessage(e):this.handleInboundMessage(e)}))}catch(e){console.error(e)}}log(...e){this.debug&&console.log(`[${this.platform.entry}]`,...e)}on(e,t){this.eventCallbacks[e]=t}setMarusiaState(e){var t,s,i;this.log("setMarusiaState: ",e),this.marusiaState=e,null==(t=this.marusiaButton)||t.setIconState(this.marusiaState),null==(s=(i=this.eventCallbacks).state_update)||s.call(i,e)}interruptOtherEntries(){const e=y();Object.keys(e).forEach((t=>{t!==this.platform.entry&&e[t]()}))}interrupt(){var e,t,s;this.isHidden||(((null==(e=this.textSoFar)?void 0:e.isRecording)||(null==(t=this.textSoFar)?void 0:t.isCreatingPhrase))&&this.textSoFar.stop(!1,!0,!0),null==(s=this.ttsPlayer)||s.stop(!1))}onClick(e){var t=this;return(0,i._)((function*(){var s,i,a;if(t.interruptOtherEntries(),t.interruptProcessingCommands(),t.isInitialized&&!t.isDisabled&&"loading"!==t.marusiaState)if(t.isSpeaking){var r;null==(r=t.ttsPlayer)||r.stop()}else{var n,l;if(null==(s=t.ttsPlayer)||s.reduceMediaVolume(),null==(i=t.ttsPlayer)||i.prepareSoundPlay(),null==(a=t.ttsPlayer)||a.prepareTtsPlay(),t.audioPlayer&&!t.audioPlayer.isPlaying()&&t.audioPlayer.preparePlay(),!t.textSoFar)t.textSoFar=new o.TextSoFar(t.onPhraseUpdate.bind(t),t.onPhraseFinish.bind(t),t.onStatusUpdate.bind(t),t.onAudioProcess.bind(t),(()=>({isHidden:t.isHidden,currentShowCount:t.showCount})),t.api,null!=(n=t.audioPlayer)?n:void 0),t.setMarusiaState("loading");if(t.textSoFar.isRecording)t.textSoFar.graceStop(),t.textSoFar.stop(!1,!0),null==(l=t.ttsPlayer)||l.restoreMediaVolume();else t.textSoFar.setInstanceId(e),yield t.textSoFar.init()}}))()}clearTextInput(){var e;this.textInput&&(null==(e=this.setTextValue)||e.call(this,this.textInput,""))}stopListening(){var e,t,s;((null==(e=this.textSoFar)?void 0:e.isRecording)||(null==(t=this.textSoFar)?void 0:t.isCreatingPhrase))&&this.textSoFar.stop(!1,!0),null==(s=this.ttsPlayer)||s.stop()}isReady(){return this.isInitialized&&!this.isLoading}dispose(){var e,t;this.stopListening(),this.textSoFar=null,this.backendCommandsQueue=[],this.textInput&&(this.textInput.removeEventListener("input",this.handleTextInput.bind(this)),this.textInput=null),this.marusiaButton&&(this.marusiaButton.dispose(),this.marusiaButton=null),null==(e=this.suggestManager)||e.unmount(),this.suggestManager=null,null==(t=this.ttsPlayer)||t.stop(),this.ttsPlayer=null,this.unsubscribeFromPlayerStore(),this.hide(),this.isInitialized=!1}constructor(e){this.suggestsFlat=!1,this.debug=!1,this.statCollector=new v.MarusiaStatCollector,this.BACKEND_COMMAND_TIMEOUT=3e4,this.isInitialized=!1,this.suggestManager=null,this.isLoading=!1,this.isSpeaking=!1,this.isRecording=!1,this.isHidden=!0,this.isDisabled=!1,this.sessionId=null,this.staticStorage=null,this.marusiaState="ready",this.textInput=null,this.backendCommandsQueue=[],this.unsubscribeFromPlayerStore=()=>{},this.marusiaButton=null,this.ttsPlayer=null,this.textSoFar=null,this.onHelpClick=()=>{},this.outboundMessageIds=[],this.setTextValue=void 0,this.eventCallbacks={},this._messageId=0,this.processCommandsQueue=[],this.processingCommands={},this.showCount=0,this.platform=e.platform,this.api=e.api,this.showSkillListModal=e.showSkillListModal,this.audioPlayer=e.audioPlayer,this.commands=e.commands,this.getTextFromInputEvent=e.getTextFromInputEvent,this.suggestsFlat=!!e.suggestsFlat,this.debug=!!e.debug,e.suggestManager&&(this.suggestManager=e.suggestManager),e.marusiaButton&&(this.marusiaButton=e.marusiaButton),y()[this.platform.entry]=()=>this.interrupt()}}},405861:(e,t,s)=>{s.d(t,{Wave:()=>r});var i=s(163293),a=s.n(i);class r{start(){this.wave.start()}stop(){this.wave.stop()}dispose(){this.wave.stop(),this.wave.dispose()}update(e){this.cache||(this.cache=new Uint8Array(e.frequencyBinCount)),e.getByteFrequencyData(this.cache);const t=r.getAverageVolume(this.cache),s=10*this.getAlignedVolume(t);this.wave.setAmplitude(s>this.maxVisibleAmp?this.maxVisibleAmp:s)}getAlignedVolume(e){const{min:t,max:s}=this.volumeRange;return((e=e<t?t:e>s?s:e)-t)/(s-t)}static getAverageVolume(e){return e.reduce(((e,t)=>e+t),0)/e.length}constructor(e,t,s){this.volumeRange=e,this.maxVisibleAmp=t,this.wave=new(a())(s)}}},791762:(e,t,s)=>{var i;function a(e){return 6===e||5===e||3===e||4===e}function r(e){return 5===e||3===e}s.d(t,{isErrorOccurred:()=>r,isFinalStatus:()=>a}),function(e){e[e.OKAY_GO_ON=1]="OKAY_GO_ON",e[e.KEYWORD_CONFIRMED=2]="KEYWORD_CONFIRMED",e[e.KEYWORD_NOT_CONFIRMED=3]="KEYWORD_NOT_CONFIRMED",e[e.END_OF_PHRASE=4]="END_OF_PHRASE",e[e.ERROR_OCCURRED=5]="ERROR_OCCURRED",e[e.PHRASE_RECOGNIZED=6]="PHRASE_RECOGNIZED"}(i||(i={}))},39460:(e,t,s)=>{s.d(t,{TextSoFar:()=>l});var i=s(11010),a=s(29271),r=s(589100),n=s(791762),o=s(459357);class l{setInstanceId(e){this.instanceId=e}init(){var e=this;return(0,i._)((function*(){e.isCreatingPhrase=!0;const t=e.checkMarusiaVisibility().currentShowCount;e.currentShowCount=t,e.onStatusUpdate(r.TextSoFarStatus.INIT);try{const t={audio:{advanced:[{}]}};e.mediaStream=yield navigator.mediaDevices.getUserMedia(t)}catch(t){e.onStatusUpdate(r.TextSoFarStatus.ERROR);let s=t.name;switch(t.name){case"DevicesNotFoundError":case"NotFoundError":case"NotAllowedError":s=a.getLang("mail_audio_message_device_error");break;case"PermissionDeniedError":case"PermissionDismissedError":s=a.getLang("mail_audio_message_permission_error");break;case"Unsupported":s=a.getLang("mail_audio_message_unsupported_error")}throw e.onError(s),e.isCreatingPhrase=!1,t}e.onStatusUpdate(r.TextSoFarStatus.MEDIA_STREAM_ACQUIRED),e.recorder=new o.MarusiaMediaRecorder(e.mediaStream,e.onAudioProcess),e.abortController=new AbortController;try{var s;const i=yield e.api.createAsrPhrase(null==(s=e.player)?void 0:s.getPlayerData(),e.abortController.signal);if(e.phraseId=i.result.phrase_id,e.shouldInterrupt(t))return e.stopRecorder(),void e.onStatusUpdate(r.TextSoFarStatus.API_ERROR)}catch(t){return e.stopRecorder(),void e.onStatusUpdate(r.TextSoFarStatus.API_ERROR)}finally{e.isCreatingPhrase=!1}e.onStatusUpdate(r.TextSoFarStatus.PHRASE_CREATED)}))()}start(){this.attachDataAvailableHandler(),this.startRecorder()}shouldInterrupt(e){const t=this.checkMarusiaVisibility(),s=null!=e?e:this.currentShowCount;return!(!t.isHidden&&s===t.currentShowCount)}startRecorder(){this.recorder.start(200),this.onStatusUpdate(r.TextSoFarStatus.RECORDING),this.isRecording=!0}stopRecorder(){this.recorder.stop(),this.recorder.stream.getTracks().forEach((e=>e.stop())),this.mediaStream=null,this.isRecording=!1,this.recorder.removeEventListener("dataavailable",this.dataAvailableCallback)}attachDataAvailableHandler(){let e=0;var t=this;this.dataAvailableCallback=(0,i._)((function*(s){t.enqueueChunk({chunkNumber:e++,eventData:s.data})})),this.recorder.addEventListener("dataavailable",this.dataAvailableCallback)}enqueueChunk(e){this.chunks.push(e),this.gracefulStopRequested&&(this.recorder.removeEventListener("dataavailable",this.dataAvailableCallback),this.processChunks(!0)),!1===this.isChunksBeingProcessed&&this.processChunks()}processChunks(e=!1){var t=this;return(0,i._)((function*(){if(t.gracefulStopRequested&&!e)return;if("recording"===t.recorder.state&&0===t.chunks.length)return void(t.isChunksBeingProcessed=!1);if(0===t.chunks.length)return;t.isChunksBeingProcessed=!0;let s=t.chunks.shift();try{const i=yield t.api.addChunk(t.phraseId,s.chunkNumber,e,s.eventData,t.abortController.signal);if(t.onPhraseUpdateHandler(i),(0,n.isFinalStatus)(i.status)||e)return void(yield t.stop((0,n.isErrorOccurred)(i.status)));yield t.processChunks()}catch(e){if("AbortError"===e.name)return;t.onStatusUpdate(r.TextSoFarStatus.API_ERROR),yield t.stop(!0)}}))()}graceStop(){this.gracefulStopRequested=!0,this.onStatusUpdate(r.TextSoFarStatus.GRACE_STOP)}stop(e=!1,t=!1,s=!1){var a=this;return(0,i._)((function*(){if(!1===a.gracefulStopRequested&&a.onStatusUpdate(r.TextSoFarStatus.PRE_RESULT),a.abortController.abort(),a.stopRecorder(),a.chunks=[],a.isChunksBeingProcessed=!1,a.gracefulStopRequested=!1,s)a.onStatusUpdate(r.TextSoFarStatus.INTERRUPT);else if(t)a.onStatusUpdate(r.TextSoFarStatus.NOTHING);else if(e)a.onStatusUpdate(r.TextSoFarStatus.ERROR);else try{const e=yield a.api.getPhraseResult(a.phraseId);if(a.shouldInterrupt())return void a.onStatusUpdate(r.TextSoFarStatus.NOTHING);if(a.onPhraseFinishHandler(a.instanceId,a.phraseId,e),0===e.result.commands.length&&0===e.result.controls.length)return void a.onStatusUpdate(r.TextSoFarStatus.NOTHING);a.onStatusUpdate(r.TextSoFarStatus.SUCCESS)}catch(e){a.onStatusUpdate(r.TextSoFarStatus.API_ERROR)}}))()}constructor(e,t,s,i,a,r,n){this.isRecording=!1,this.isCreatingPhrase=!1,this.chunks=[],this.abortController=new AbortController,this.isChunksBeingProcessed=!1,this.gracefulStopRequested=!1,this.onError=()=>{},this.currentShowCount=0,this.instanceId="",this.onPhraseUpdateHandler=e,this.onPhraseFinishHandler=t,this.onStatusUpdate=s,this.onAudioProcess=i,this.checkMarusiaVisibility=a,this.api=r,this.player=n}}},589100:(e,t,s)=>{var i;s.d(t,{TextSoFarStatus:()=>i}),function(e){e[e.INIT=0]="INIT",e[e.MEDIA_STREAM_ACQUIRED=1]="MEDIA_STREAM_ACQUIRED",e[e.PHRASE_CREATED=2]="PHRASE_CREATED",e[e.RECORDING=3]="RECORDING",e[e.API_ERROR=4]="API_ERROR",e[e.GRACE_STOP=5]="GRACE_STOP",e[e.PRE_RESULT=6]="PRE_RESULT",e[e.NOTHING=7]="NOTHING",e[e.SUCCESS=8]="SUCCESS",e[e.ERROR=9]="ERROR",e[e.INTERRUPT=10]="INTERRUPT"}(i||(i={}))},974861:(e,t,s)=>{var i;s.d(t,{ControlType:()=>i}),function(e){e.CONTROL_TYPE_RESUME="resume_control",e.CONTROL_TYPE_PAUSE="pause_control",e.CONTROL_TYPE_VOLUME="volume_control",e.CONTROL_TYPE_NEXT="next_control",e.CONTROL_TYPE_PREV="previous_control",e.CONTROL_TYPE_REPEAT="repeat_control",e.CONTROL_TYPE_REPEAT_PLAYLIST="repeat_playlist_control",e.CONTROL_TYPE_REWIND="rewind_control"}(i||(i={}))},262339:(e,t,s)=>{s.d(t,{MarusiaPerformanceActionStatCollector:()=>a});var i=s(193452);class a{logEvent(e){const t={type:"type_marusia_performance_item",type_marusia_performance_item:e};this.actionStatCollector.logEvent(t)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.actionStatCollector=new i.ActionStatCollector(this.productStatCollector)}}},235431:(e,t,s)=>{s.d(t,{settingsChangesStatCollector:()=>a});var i=s(193452);const a=new class{logEvent(e){const t={type:"type_settings_changes_item",type_settings_changes_item:e};this.actionStatCollector.logEvent(t)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.actionStatCollector=new i.ActionStatCollector(this.productStatCollector)}}},1483:(e,t,s)=>{s.d(t,{MarusiaConversationClickStatsCollector:()=>r});var i=s(193452),a=s(957973);class r{logEvent(e){const t={type:a.ClickProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM,[a.ClickProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM]:e},s={type:a.EventItemType.CLICK_ITEM};this.clickStatCollector.logEvent(t,s)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.clickStatCollector=new i.ClickStatCollector(this.productStatCollector)}}},567161:(e,t,s)=>{s.d(t,{MarusiaConversationViewStatsCollector:()=>r});var i=s(193452),a=s(957973);class r{logEvent(e){const t={end_view:"0",start_view:"0",type:a.ViewProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM,[a.ViewProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM]:e},s={type:a.EventItemType.EVENT};this.viewStatCollector.logEvent(t,s)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.viewStatCollector=new i.ViewStatCollector(this.productStatCollector)}}},265070:(e,t,s)=>{s.d(t,{showSkillListModal:()=>p});var i=s(434788),a=s(785893),r=s(667294),n=s(816511),o=s(400856),l=s(342787),c=s(545637),u=s(29271),d=s(140874),h=s(359639);const m=({api:e,statCollector:t,onSkillClick:s,onClose:i,refreshCoordinates:h})=>{var m,p;const{categories:g,error:_,reloadCategories:v,handleError:y,selectedCategory:f,setSelectedCategory:E}=(0,d.useCategories)(e);(0,r.useEffect)((()=>{h()}),[]);const S=(0,r.useCallback)((e=>{t.logConversationView({type:"hint",suggest_item:{suggests:e.map((e=>({text:e.title})))}})}),[t]);var C;return(0,a.jsxs)(n.ModalBox,{"data-testid":"marusia-skill-modal",children:[(0,a.jsx)(o.ModalHeader,{onClose:i,closeAriaLabel:u.getLang("global_close"),backLabel:f&&u.getLang("global_back"),onBack:()=>{E(null)},children:null!=(C=null==(m=f)?void 0:m.title)?C:u.getLang("mail_marusia_bottom_sheet_skills_title")}),(0,a.jsx)(l.ModalScrollView,{height:_?void 0:525,children:(0,a.jsx)(c.Div,{mode:"horizontal",spacing:8,children:(0,a.jsx)(d.CategoriesModalBody,{api:e,categories:g,selectedCategory:null==(p=f)?void 0:p.name,onItemClick:(e,t)=>{s((0,d.itemToSuggest)(e),t.map(d.itemToSuggest)),i()},onItemView:S,onShowMoreClick:(e,t)=>{E({name:e,title:t})},error:_,onError:y,reloadCategories:v})})})]})};function p(e,t,s){(0,h.showMessageBoxModal)((r=>(0,a.jsx)(m,(0,i._)({},r,{api:e,statCollector:t,onSkillClick:s}))),{width:420})}},934857:(e,t,s)=>{s.d(t,{MarusiaVkcomAdapter:()=>n});var i=s(465889);const a="_im_page_history",r="im-page--marusia";class n{set onHelpClick(e){this._onHelpClick=e}show(){var e,t;null==(e=document.querySelector("."+a))||e.classList.add(r),null==(t=document.querySelector("."+i.MARUSIA_HELP_BUTTON_CLASS))||t.addEventListener("click",this._onHelpClick)}hide(){var e,t;null==(e=document.querySelector("."+a))||e.classList.remove(r),null==(t=document.querySelector("."+i.MARUSIA_HELP_BUTTON_CLASS))||t.removeEventListener("click",this._onHelpClick)}constructor(){this._onHelpClick=()=>{},this.entry="vkcom"}}},429156:(e,t,s)=>{s.d(t,{MarusiaWebApi:()=>o});var i=s(150111),a=s(905507),r=s(111863);const n=new a.FetchService;class o extends i.MarusiaSharedApi{reloadAudios(e){return n.reloadAudios(e)}generateDeviceId(){return(0,r.generateDeviceId)("vk_web",this.debug)}}},812790:(e,t,s)=>{s.d(t,{MarusiaWebCommands:()=>o});var i=s(468387),a=s(938141),r=s(465476),n=s(958678);class o{processMedia(e,t,s,a){return(0,i.processCommandMedia)(e,t,s,a)}processPlaylist(e,t,s){(0,i.processCommandPlaylist)(e,t,s)}processPortalDeeplink(e){window.open(e.url,"_self")}processNeedMoreVkPermissions(e,t,s){return(0,a.processCommandNeedMoreVkPermissions)(e,t,s)}processCallStart(e){(0,r.processCommandCallStart)(e)}autoPlayMediaAttaches(e,t,s,a,r){return(0,i.autoPlayMediaAttaches)(e,t,s,a,r)}executeControl(e,t){(0,n.executeControl)(e,t)}}},465476:(e,t,s)=>{s.d(t,{processCommandCallStart:()=>a});var i=s(292071);function a(e){window.Calls&&window.Calls.call&&!window.Calls.isInActiveCall&&window.Calls.call(parseInt(String(e.recipient_id)),!1,void 0,i.CallStatSource.CONVO_HEADER)}},468387:(e,t,s)=>{s.d(t,{autoPlayMediaAttaches:()=>d,playAudioList:()=>u,processCommandMedia:()=>g,processCommandPlaylist:()=>v});var i=s(11010),a=s(434788),r=s(145669),n=s(661893),o=s(285853),l=s(391199),c=s(269425);function u(e,t,s,i){e.getCurrentPlaylist()&&e.deleteCurrentPlaylist();const a=new r.AudioPlaylist({accessHash:void 0,albumId:`im${n.MARUSIA_PEER_ID}_${s}`,blockId:"",hasMore:!1,ownerId:window.vk.id,type:null!=i?i:r.AudioPlaylist.TYPE_TEMP});a.mergeWith({list:t}),e.addPlaylist(a),e.play((0,c.getFullIdFromTuple)(t[0]),a,"im")}function d(e,t,s,i,a){return h.apply(this,arguments)}function h(){return(h=(0,i._)((function*(e,t,s,i,a){if(!s.length)return;if(s.every(p)){return void u(t,s.map((e=>(0,c.constructPlayerAudio)(e.meta,o.MarusiaMediaType.books,{}))),a)}const r=(0,c.getCommandsToAutoplay)(s,i),n=r.every((e=>e.media_type===o.MarusiaMediaType.podcast));if(0===r.length)return;const d=i.filter((e=>e.attaches.some(c.isAudioAttach))).map((e=>document.querySelector(`._im_mess[data-msgid="${e.messageId}"]`))).filter(Boolean);var h,m,g;if(d&&(yield(h=d,new Promise(((e,t)=>{let s=!1;const i=setTimeout((()=>{s=!0,t(new Error(l.MarusiaError.ATTACH_LOAD_TIMEOUT))}),3e4),a=()=>{h.every((e=>!!e.querySelector("._audio_row")||!!e.querySelector(".im_msg_media_podcast")))?(clearTimeout(i),e()):s||setTimeout(a,100)};a()})))),n)return void(null==(g=d[0])||null==(m=g.querySelector(".podcast_snippet__play"))||m.click());const _=r.map((e=>(0,c.constructPlayerAudio)(e.meta,o.MarusiaMediaType.music,(0,c.getVoiceAssistantData)(e,i)))),v=yield(0,c.getHashesForAudios)(e,_);v&&u(t,v,a)}))).apply(this,arguments)}function m(e){return"media"===e.type&&e.media_type===o.MarusiaMediaType.radio}function p(e){return"media"===e.type&&e.media_type===o.MarusiaMediaType.books}function g(e,t,s,i){return _.apply(this,arguments)}function _(){return(_=(0,i._)((function*(e,t,s,i){const a=s.find(m);if(a)return void function(e,t,s){u(e,[(0,c.constructPlayerAudio)(t.meta,o.MarusiaMediaType.radio,{source:t.meta.source})],s,r.AudioPlaylist.TYPE_RADIO)}(e,a,i);const n=yield(0,c.getAudioList)(t,s);n&&u(e,n,i)}))).apply(this,arguments)}function v(e,t,s){var i;u(e,t.tracks.map(((e,t)=>(0,a._)({},e,{meta:(0,a._)({},e.meta,{id:null!=(i=e.meta.id)?i:t})}))).map((e=>(0,c.constructPlayerAudio)(e.meta,t.media_type))),s)}},958678:(e,t,s)=>{s.d(t,{executeControl:()=>r});var i=s(322498),a=s(974861);function r(e,t){var s;const r=null==(s=document.querySelector("._audio_page_layout"))?void 0:s.firstChild,n=r?(0,i.currentAudioPage)(r):null;switch(t.type){case a.ControlType.CONTROL_TYPE_RESUME:e.play();break;case a.ControlType.CONTROL_TYPE_PAUSE:e.pause();break;case a.ControlType.CONTROL_TYPE_VOLUME:e.setVolume(t.level/100);break;case a.ControlType.CONTROL_TYPE_NEXT:e.playNext(!0);break;case a.ControlType.CONTROL_TYPE_PREV:e.seekToTime(0),setTimeout((()=>e.playPrev()));break;case a.ControlType.CONTROL_TYPE_REPEAT:var o;e.toggleRepeatCurrentAudio(),null==(o=n)||o.updateRepeatButton();break;case a.ControlType.CONTROL_TYPE_REPEAT_PLAYLIST:var l;e.toggleRepeatAll(),null==(l=n)||l.updateRepeatButton();break;case a.ControlType.CONTROL_TYPE_REWIND:e.seekToTime(t.elapsed)}}},468014:(e,t,s)=>{s.r(t),s.d(t,{marusiaSdk:()=>p});var i=s(727745),a=s(812790),r=s(715203),n=s(265070),o=s(429156),l=s(95432),c=s(934857),u=s(78024),d=s(476091);const h=new c.MarusiaVkcomAdapter,m="vkcom-marusia",p=new i.MarusiaSharedSdk({platform:h,api:new o.MarusiaWebApi(window.__dev),showSkillListModal:n.showSkillListModal,audioPlayer:new r.MarusiaWebPlayerAdapter((0,l.getAudioPlayer)()),commands:new a.MarusiaWebCommands,getTextFromInputEvent:e=>e.target.innerText,debug:window.__dev,suggestManager:new u.SuggestManager(m),marusiaButton:new d.MarusiaButton});h.onHelpClick=()=>{p.onHelpClick(m)}},239301:(e,t,s)=>{s.d(t,{loadMarusiaFCSdk:()=>n,loadMarusiaSdk:()=>r});var i=s(659397),a=s(508159);function r(){return(0,i.asyncImportLoader)((()=>Promise.resolve().then(s.bind(s,468014))),3).then((e=>{if(!e.marusiaSdk)throw new Error("MarusiaSdkEmptyError");return e.marusiaSdk})).catch((e=>(a.marusiaStats.logModuleLoadError(e.message),null)))}function n(){return(0,i.asyncImportLoader)((()=>s.e(3225).then(s.bind(s,242808))),3).then((e=>{if(!e.marusiaSdk)throw new Error("MarusiaFCSdkEmptyError");return e.marusiaSdk})).catch((e=>(a.marusiaStats.logModuleLoadError(e.message),null)))}},189693:(e,t,s)=>{s.r(t),s.d(t,{showGroupChatInviteBox:()=>k});var i=s(434788),a=s(785893),r=s(667294),n=s(659397),o=s(86894),l=s(816511),c=s(400856),u=s(545637),d=s(736415),h=s(366897),m=s(126116),p=s(832550),g=s(900917),_=s(29271),v=s(643897),y=s(584356),f=s(514986),E=s(672132),S=s(600292),C=s(359639);class I extends r.Component{onRemoveToken(e){return e=Number(e),this.setState({selected:this.state.selected.filter((t=>t!==e))}),Promise.resolve()}onChange(e){this.isSearching=!0;const t=e.target.value;this.searchChats(t,((e,t)=>{this.abortOngoingRequest&&this.abortOngoingRequest(),this.abortOngoingRequest=e,t.then((e=>{e.forEach((e=>{this.data[e.peer_id]||this.indexer.add(e),this.data[e.peer_id]=e})),this.isSearching=!1,this.setState({found:(0,n.uniqueArray)(this.state.found.concat(e.map((e=>Number(e.peer_id)))))})})).catch((e=>{(0,v.debugLog)("cancelled promise",e)}))})),this.setState({value:t,found:(0,n.uniqueArray)(this.indexer.search(t).map((e=>Number(e.peer_id))))})}onSelect(e){let t;e=Number(e),t=this.state.selected.includes(e)?this.state.selected.filter((t=>t!==e)):this.state.selected.concat(e),t=t.slice(0,10);let s=this.state.value;return t.length!==this.state.selected.length&&(s=""),this.setState({selected:t,value:s}),Promise.resolve()}onAddBots(){this.setState({loading:!0});const e=this.state.selected;var t,s,i;(t=-this.props.groupId,s=e,i=this.props.addHash,new Promise(((e,a)=>{window.ajax.post("/al_im.php",{act:"a_add_bots_to_chat",bot_id:t,peer_ids:s.join(","),add_hash:i},{onDone(t){e(t)},onFail:e=>(a(e),!0)})}))).then((e=>{this.props.onClose(),(0,y.showDoneBox)(e)})).catch((e=>((0,f.showFastBox)(_.getLang("global_error"),e),!0))).finally((()=>{this.setState({loading:!1})}))}render(){const{selected:e,value:t}=this.state,s=Object.keys(e).length,i=""===t?this.state.defaultData:this.state.found;return(0,a.jsxs)(l.ModalBox,{children:[(0,a.jsx)(c.ModalHeader,{closeAriaLabel:_.getLang("global_close"),onClose:()=>this.props.onClose(),children:this.props.title}),(0,a.jsx)(u.Div,{className:S.default.container,children:(0,a.jsx)(d.ChipsInputCellList,{value:e.map((e=>({value:e,label:(0,n.decodeHTMLEntities)(this.data[e].name),removeAriaLabel:_.getLang("groups_invite_chat_remove")}))),onChange:e=>{this.setState({selected:e.map((e=>e.value))})},placeholder:_.getLang("groups_invite_chat_search"),inputValue:t,onInputChange:e=>{this.onChange(e)},hasScroll:!0,isEmpty:!i.length,emptyPlaceholderText:t.length?_.getLang("groups_invite_chat_not_found"):_.getLang("groups_invite_chat_no_chats"),autoFocus:!0,children:i.map((t=>{const s=this.data[t],{photo:i,name:r}=s,l=(0,n.decodeHTMLEntities)(r),c=e.includes(t);return(0,a.jsx)(o.Cell,{mode:"selectable",checked:c,onChange:()=>this.onSelect(t),before:"string"==typeof i?(0,a.jsx)(h.Avatar,{size:34,src:i}):(0,a.jsx)(h.Avatar,{size:34,initials:Array.from(l)[0],gradientColor:(0,o.calcInitialsAvatarColor)(t)}),badgeAfterTitle:s.is_casper?(0,a.jsx)(g.Icon16Ghost,{}):null,children:l},t)}))})}),(0,a.jsx)(m.ModalFooter,{actionButtons:(0,a.jsx)(p.Button,{size:"m",mode:"primary",disabled:0===s,onClick:this.onAddBots.bind(this),loading:this.state.loading,children:_.getLang("groups_invite_chat_invite")})})]})}constructor(e){super(e),this.searchChats=(0,n.debounce)(((e,t)=>{const{abort:s,promise:i}=function(e,t){let s,i;return{abort(){i.abort(),s()},promise:new Promise(((a,r)=>{s=r,i=window.ajax.post("/al_im.php",{act:"a_search_chats",q:e,group_id:t},{onDone(e){a(e)},onFail:()=>!0})}))}}(e,this.props.groupId);t(s,i)}),200),this.indexer=new E.vkIndexer([],(e=>e.name)),this.data={},e.initialData.forEach((e=>{this.data[e.peer_id]||this.indexer.add(e),this.data[e.peer_id]=e})),this.state={selected:[],value:"",loading:!1,found:[],defaultData:e.initialData.map((e=>Number(e.peer_id)))}}}const k=e=>{window.ajax.post("/al_groups.php",{act:"a_search_chats_box",group_id:e},{onDone(t){!function(e,t){(0,C.showMessageBoxModal)((s=>(0,a.jsx)(I,(0,i._)({},s,{title:e.title,initialData:e.results.map((e=>(0,i._)({},e,{peer_id:Number(e.peer_id)}))),addHash:e.add_hash,groupId:t}))),{width:560})}((0,n.decodeHTMLEntitiesDeep)(t),e)},showProgress:()=>(0,y.showBoxLoader)(),hideProgress:()=>(0,y.hideBoxLoader)()})}},354273:(e,t,s)=>{s.d(t,{Api:()=>h});var i=s(11010),a=s(434788),r=s(816405),n=s(927411),o=s(95154),l=s(891047),c=s(599809),u=s(301230);const d=["messages.getLongPollServer","messages.getLongPollHistory","queue.subscribe","account.setOnline"];class h{static dropCache(){indexedDB.deleteDatabase(m.CACHE_DB_NAME)}dangerouslyAbort(e){var t;e&&(null==(t=this.abortTrackers.get(e))||t(),this.abortTrackers.delete(e))}fetchMany(e,t={}){var s=this;return(0,i._)((function*(){const i=[],a=[],r=[];let n=0,o=!1;for(let l=e.length-1;l>=0;l--){const c=e[l];if(!c){a[l]="null";continue}if(t.usePrefetch){const e=s.prefetch(c.method,c.params);if(e){a[l]="null",r[l]=e,n++;continue}}const u=`res${l}`,d=`API.${c.method}(${JSON.stringify(s.enrichParams(c.method,c.params))})`;o?(i[l]=`var ${u}=fork(${d});`,a[l]=`wait(${u})`):(o=!0,i[l]=`var ${u}=${d};`,a[l]=`${u}`)}if(n===e.filter(Boolean).length)return r;const l=`${i.join("")}return [${a.join(",")}];`,c=yield s.fetch("execute",{code:l},t);for(let e=0;e<c.length;e++)r[e]&&(c[e]=r[e]);return c}))()}fetchSeq(e,t){const s=[],i=[];for(let t=0;t<e.length;t++){const a=e[t];if(!a){i.push("null");continue}const r=`res${t}`;s.push(`var ${r}=API.${a.method}(${JSON.stringify(this.enrichParams(a.method,a.params))});`),i.push(`${r}`)}const a=`${s.join("")}return [${i.join(",")}];`;return this.fetch("execute",{code:a},t)}fetchForExternalLibs(e,t,s){return this.fetch(e,t,(0,a._)({},s,{fromExternalLib:!0}))}prefetch(e,t){if(!this.prefetchCache)return;t=this.enrichParams(e,t);const s=this.prefetchCache.findIndex((s=>s.version===r.API_VERSION&&(s.method===e&&(Object.keys(t).length===Object.keys(s.request).length&&Object.keys(t).every((e=>t[e]===s.request[e])))))),i=this.prefetchCache[s];return i&&(this.prefetchCache.splice(s,1),!i.error)?i.response:void 0}constructor(e){var t,s;this.prefetchCache=(null==(s=window)||null==(t=s.cur)?void 0:t.apiPrefetchCache)||[],this.abortTrackers=new Map;var l=this;this.fetch=(0,i._)((function*(e,t,s={}){if("queue.subscribe"===e)return Promise.resolve({base_url:"mock",queues:[]});if(s.usePrefetch){const s=l.prefetch(e,t);if(s)return s}s.timeout||(s.timeout=1e4),s.fromExternalLib||(t=l.enrichParams(e,t));const i=d.includes(e),a=`${e} ${JSON.stringify(t)}`;let r=s.retries||0,o=0;for(;;)try{if(i&&window.curNotifier&&!window.curNotifier.is_server&&!u.browser.safari){yield p((c=500,h=1500,Math.random()*(h-c+1)+c));const e=yield l.cache.get(a);if(e)return e}const{response:r,abort:o}=l.request(e,t,s.timeout);s.trackId&&l.abortTrackers.set(s.trackId,o);const d=yield r.catch((e=>{if(e&&"api_error"===e.type){const{error_code:t,error_message:s}=e.error;throw new n.IApi.RequestError(t,s,e.error)}throw e})).finally((()=>{s.trackId&&l.abortTrackers.delete(s.trackId)}));if(d.execute_errors)throw new n.IApi.ExecuteErrors(d.execute_errors);return i&&l.cache.set(a,d).catch((()=>{})),d}catch(e){if(e instanceof n.IApi.AbortError)throw e;if(o++,o===r+1)throw e;yield p(Math.min(500*Math.pow(2,o-1),2e4))}var c,h})),this.request=(e,t,s)=>{const i=new AbortController;let a,o=!1;s&&(a=window.setTimeout((()=>{o=!0,i.abort()}),s));const l={};for(const e of Object.keys(t))void 0!==t[e]&&(l[e]=t[e]);return{response:(0,c.api)(e,l,{version:r.API_VERSION},{signal:i.signal}).catch((t=>{if(i.signal.aborted)throw o?new n.IApi.TimeoutError(`[API] Timeout Error: ${e}`):new n.IApi.AbortError(`[API] Abort Error: ${e}`);throw t})).finally((()=>{a&&clearTimeout(a)})),abort:()=>{i.abort()}}},this.enrichParams=(e,t)=>{switch(e.slice(0,e.indexOf("."))){case"users":case"friends":return(0,a._)({},t,{fields:o.API_USER_FIELDS.join(",")});case"groups":return(0,a._)({},t,{fields:o.API_GROUP_FIELDS.join(",")});default:return"extended"in t&&t.extended?(0,a._)({},t,{fields:Array.from(new Set([...o.API_USER_FIELDS,...o.API_GROUP_FIELDS])).join(",")}):t}},this.cache=new m(3e3,e)}}class m{get(e){return l.get(e,this.cache).then((t=>{if(void 0!==t){if(!(t.expiresAt<Date.now()))return setTimeout((()=>{l.del(e,this.cache).catch((()=>{}))}),Date.now()-t.expiresAt),t.response;l.del(e,this.cache).catch((()=>{}))}})).catch((()=>{}))}set(e,t){const s={response:t,expiresAt:Date.now()+this.invalidateTimeout};return l.set(e,s,this.cache).then((()=>{setTimeout((()=>{l.del(e,this.cache).catch((()=>{}))}),this.invalidateTimeout)})).catch((()=>{}))}constructor(e,t){this.invalidateTimeout=e,this.cache=l.createStore(m.CACHE_DB_NAME,"api-cache-"+t)}}function p(e){return new Promise((t=>setTimeout(t,e)))}m.CACHE_DB_NAME="reforged-db-v1"},415102:(e,t,s)=>{s.d(t,{BrowserNotifications:()=>a});var i=s(945263);class a{constructor(){this.getState=()=>{var e;return(null==(e=window.pushNotifier)?void 0:e.loadEndpoint())||window.ls.get("im_ui_notify_off")?"external":this.isBrowserNotificationsEnabled()},this.onChange=e=>e&&!this.isBrowserNotificationsEnabled()?new Promise((e=>{window.DesktopNotifications.requestPermission((()=>{this.statlogsBrowserNotificationsOn(),e("external")}))})):!e&&this.isBrowserNotificationsEnabled()?(window.ls.set("im_ui_notify_off",1),this.statlogsBrowserNotificationsOff(),Promise.resolve(!1)):Promise.resolve(e),this.onExternal=()=>window.nav.go("/settings?act=notify"),this.isBrowserNotificationsEnabled=()=>window.DesktopNotifications.supported()&&!window.DesktopNotifications.checkPermissionNeeded()&&!window.ls.get("im_ui_notify_off"),this.statlogsBrowserNotificationsOn=()=>{(0,i.statlogsProbValueEvent)(1,"im_browser_notifications_on",1)},this.statlogsBrowserNotificationsOff=()=>{(0,i.statlogsProbValueEvent)(1,"im_browser_notifications_off",1)}}}},605836:(e,t,s)=>{s.d(t,{GeoLocation:()=>a});var i=s(12402);class a{get(){return new Promise((e=>{(0,i.sendLocationFromKeyboard)((([,t])=>{const[s,i]=t.split("_");e([s,i])}))}))}}},727539:(e,t,s)=>{s.d(t,{Idle:()=>i});class i{constructor(e){this.logger=e,this.listeners=new Set,this.isIdle=()=>void 0===this.timeoutId,this.subscribe=e=>(this.listeners.add(e),()=>{this.listeners.delete(e)}),this.onVisibilityChange=()=>{document.hidden?(document.removeEventListener("mousemove",this.onActive),document.removeEventListener("keydown",this.onActive,!0),this.onIdle()):(document.addEventListener("mousemove",this.onActive),document.addEventListener("keydown",this.onActive,!0),this.onActive())},this.onIdle=()=>{this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0,this.notify())},this.onActive=()=>{const e=void 0!==this.timeoutId;this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(this.onIdle,3e4),e||this.notify()},this.notify=()=>{this.logger.info("[IDLE]","user became "+(this.isIdle()?"idle":"active"));for(const e of this.listeners)e(this.isIdle())},this.onVisibilityChange(),document.addEventListener("visibilitychange",this.onVisibilityChange)}}},232621:(e,t,s)=>{s.d(t,{Logger:()=>a});var i=s(543020);class a{constructor(){this.visible=!1,this.configureScope=()=>{},this.info=(...e)=>{this.visible&&console.log(...e)},this.error=(e,t)=>{t?console.error(e,t):console.error(e);const s=e=>{(0,i.logError)(e,{environment:"messenger"})};if(t instanceof Error){const i=new Error(e+" "+t.message);return i.name=t.name,i.stack=t.stack,s(i)}if("string"==typeof t)return s(new Error(e+" "+t));if(t&&"api_error"===t.type){const i=JSON.stringify(t.error);return s(new Error(e+" "+i))}return s(new Error(e))},this.show=()=>{this.visible=!0},this.hide=()=>{this.visible=!1}}}},891172:(e,t,s)=>{s.d(t,{Notification:()=>u});var i=s(11010),a=s(241857),r=s(795558),n=s(664988),o=s(29271),l=s(765789);const c="/images/icons/favicons/";class u{getIconSuffix(){return window.devicePixelRatio>=1.25?"_2x":""}isIM(){return"im"===window.cur.module||"im_settings"===window.cur.module}isMasterTab(){return!(!window.curNotifier||!window.curNotifier.is_server)}isEnabled(){return!!window.vkmeIntegration&&(!!this.isIM()&&!!this.isMasterTab())}safariAudioPlayFix(e){document.body.addEventListener("mousedown",(function t(){const s=e.volume;e.volume=0,e.play().catch((()=>{})),e.pause(),e.currentTime=0,e.volume=s,document.body.removeEventListener("mousedown",t)}))}play(){var e=this;return(0,i._)((function*(){try{var t,s;null==(t=e.audio)||t.load(),yield null==(s=e.audio)?void 0:s.play()}catch(e){}}))()}notify(){}playSound(){this.isEnabled()&&this.play()}setCounters({unreadIdle:e=0}){if(this.isEnabled()&&this.idle.isIdle()){if(this.oldTitle||(this.oldTitle=document.title),0===e)return this.clear(),void(this.oldTitle=void 0);this.unreadCount=e,this.updateInterval||(this.updateInterval=window.setInterval((()=>this.updateTab()),this.titleUpdateInterval),this.updateTab())}}updateTab(){const e=this.getIconSuffix();if(this.oldTitle===document.title){const t=this.unreadCount>9?10:this.unreadCount;(0,a.setFavIcon)(c+"fav_im"+t+e+".ico"),(0,r.setDocumentTitle)((0,n.winToUtf)(o.getLang("mail_im_new_messages",this.unreadCount)))}else(0,r.setDocumentTitle)(this.oldTitle),(0,a.setFavIcon)(c+"fav_im"+e+".ico")}clear(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null,this.unreadCount=0,(0,a.setFavIcon)(c+"fav_im"+this.getIconSuffix()+".ico"),(0,r.setDocumentTitle)(this.oldTitle))}reset(){this.clear(),(0,a.setFavIcon)(c+"fav_logo"+this.getIconSuffix()+".ico")}constructor(e,t=1e3,s){this.idle=e,this.titleUpdateInterval=t,this.unreadCount=0,this.updateInterval=null,this.audio=null,this.audio=new Audio(s),this.audio.preload="auto",this.audio.loop=!1,this.audio.load(),l.browser.safari&&this.safariAudioPlayFix(this.audio),this.idle.subscribe((e=>{!e&&this.isEnabled()&&this.clear()}))}}},205261:(e,t,s)=>{s.d(t,{FCPlayer:()=>m,FCVoicePlayer:()=>h});var i=s(434788),a=s(866310),r=s(95432),n=s(145669),o=s(721366),l=s(795558);const c=([e,t,s,i,a,r,,,,,,,,,,,,,,,n],o)=>({audioTrack:{id:`${t}_${e}`,url:s,progress:o,duration:r},title:i,artist:a,trackCode:n}),u=e=>{const[t,s]=e;return`${s}_${t}`},d=({audioTrack:e,title:t,artist:s,trackCode:i})=>{const{id:a,url:r,duration:n}=e,[o,l]=a.split("_");return[Number(l),Number(o),r,t,s,n,0,0,"",0,0,"im","[]","/////undefined/","",{},"","","",!1,i||"",0,0,0,"",!1]};class h extends o.EventBus{play(e){var t;if(e.audioTrack.id===(null==(t=this.state.currentTrackEntity)?void 0:t.audioTrack.id)&&"paused"===this.state.status)return this.state.currentTrackEntity=e,void this.resume();if(this.state.currentTrackEntity&&e.audioTrack.id!==this.state.currentTrackEntity.audioTrack.id){const{currentTrackEntity:e}=this.state,{audioTrack:t}=e;this.state=(0,i._)({},this.state,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},e,{audioTrack:(0,i._)({},t,{progress:0})})}),this.emit("stateupdated",this.state)}const{url:s,duration:a,id:r}=e.audioTrack,n="MessagedConvoVoiceTrack"===e.kind?e.urlOgg:void 0,o=`<div id="audiomsgpl_${window.vk.id}_${r}" class="audio-msg-track " data-duration="${a}" data-mp3="${s}" data-ogg="${n}" <button class="audio-msg-track--btn"></button> <button class="audio-msg-track--transcriptToggle _msg_asr_toggle"> <span class="audio-msg-track--transcriptToggleShow"></span> <span class="audio-msg-track--transcriptToggleHide"></span> </button> <div class="audio-msg-track--duration"></div> <div class="audio-msg-track--wave-wrapper"> <svg class="audio-msg-track--wave"></svg></div></div>`;this.audioEl=(0,l.ce)("div",{innerHTML:o}).firstChild,this.audioEl.dataset.convoVoiceTrack=JSON.stringify(e),this.state=(0,i._)({},this.state,{status:"playing",playedTimeAccumulator:{},currentTrackEntity:e}),this.emit("stateupdated",this.state),window.AudioMessagePlayer.togglePlay(this.audioEl),window.AudioMessagePlayer.seek(e.audioTrack.progress)}pause(){this.audioEl&&window.AudioMessagePlayer.toggle()}stop(){this.audioEl&&window.AudioMessagePlayer.toggle()}resume(){this.audioEl&&this.state.currentTrackEntity&&(this.audioEl.dataset.convoVoiceTrack=JSON.stringify(this.state.currentTrackEntity),window.AudioMessagePlayer.seek(this.state.currentTrackEntity.audioTrack.progress),window.AudioMessagePlayer.toggle())}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){this.resume()}handleMediaMediatorPause(){this.pause()}getState(){return this.state}playNext(){return!1}init(){}setVolume(){}setMute(){}playPrev(){}setShuffle(){}seek(){}setRepeatMode(){}setPlaybackRate(){}stopPlayer(){}constructor(e){super(),this.state={status:"stopped",playedTimeAccumulator:{},volume:100,playbackRate:1,mute:!1,shuffle:!1,repeatMode:"none"},this.mediaMediator=e,window.AudioMessagePlayer.events.on("playing",(e=>{if(this.state.currentTrackEntity&&e!==this.audioEl){const{currentTrackEntity:e}=this.state,{audioTrack:t}=e;this.state=(0,i._)({},this.state,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},e,{audioTrack:(0,i._)({},t,{progress:0})})}),this.emit("stateupdated",this.state),this.audioEl=void 0,this.state={status:"stopped",playedTimeAccumulator:{},volume:100,playbackRate:1,mute:!1,shuffle:!1,repeatMode:"none"},this.emit("stateupdated",this.state)}if(e===this.audioEl&&"string"==typeof e.dataset.audioTrack){const t=e.dataset.convoAudioTrack&&JSON.parse(e.dataset.convoAudioTrack);this.state=(0,i._)({},this.state,{status:"playing",currentTrackEntity:t}),this.emit("stateupdated",this.state)}})),window.AudioMessagePlayer.events.on("progress",((e,t)=>{if(this.audioEl===t&&this.state.currentTrackEntity){const{currentTrackEntity:t}=this.state,{audioTrack:s}=t;this.state=(0,i._)({},this.state,{currentTrackEntity:(0,i._)({},t,{audioTrack:(0,i._)({},s,{progress:e})})}),this.emit("stateupdated",this.state)}})),window.AudioMessagePlayer.events.on("fc_paused",(e=>{e===this.audioEl&&"playing"===this.state.status&&(this.state=(0,i._)({},this.state,{status:"paused"}),this.emit("stateupdated",this.state))})),window.AudioMessagePlayer.events.on("finished",(e=>{if(e===this.audioEl&&this.state.currentTrackEntity){const{currentTrackEntity:e}=this.state,{audioTrack:t}=e;this.state=(0,i._)({},this.state,{status:"ended",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},e,{audioTrack:(0,i._)({},t,{progress:0})})}),this.emit("stateupdated",this.state),this.state=(0,i._)({},this.state,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},e,{audioTrack:(0,i._)({},t,{progress:0})})}),this.emit("stateupdated",this.state)}}))}}class m extends o.EventBus{play(e,t){var s,i;const{progress:a}=e.audioTrack,r=this.vkComPlayer.getPlaylist(n.AudioPlaylist.TYPE_TEMP,window.vk.id,`im${(null==(s=e.fromMessage)?void 0:s.peerId)||""}`);r.mergeWith({list:null==(i=t)?void 0:i.getConvoAudiosList().map(d)}),this.vkComPlayer.play(d(e),r,"im"),a>0&&this.vkComPlayer.seek(a),this.vkComPlayer.play(),this.mediaMediator.handlePlayerOn(this)}pause(){this.vkComPlayer.isPlaying()&&this.vkComPlayer.pause()}stop(){this.vkComPlayer.stop()}resume(){this.vkComPlayer.isPlaying()||this.vkComPlayer.play()}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){this.resume(),this.isManualPause=!1}handleMediaMediatorPause(){this.pause(),this.isManualPause=!0}getState(){return this.state}playNext(){return!1}init(){}setVolume(){}setMute(){}playPrev(){}setShuffle(){}seek(){}setRepeatMode(){}setPlaybackRate(){}stopPlayer(){}constructor(e){super(),this.vkComPlayer=(0,r.getAudioPlayer)(),this.isManualPause=!1,this.state={status:"stopped",playedTimeAccumulator:{},volume:100,playbackRate:1,mute:!1,shuffle:!1,repeatMode:"none"},this.updateState=e=>{this.state=e,this.emit("stateupdated",this.state)},this.mediaMediator=e,this.vkComPlayer.on(this,a.events.PLAY_REQUESTED,(e=>{if(!e)return;const t=(0,i._)({},this.state);if(t.currentTrackEntity&&t.currentTrackEntity.audioTrack){const{currentTrackEntity:e}=t,{audioTrack:s}=e;this.updateState((0,i._)({},t,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},e,{audioTrack:(0,i._)({},s,{progress:0})})}))}const s=c(e,0);this.updateState((0,i._)({},this.state,{status:"playing",playedTimeAccumulator:{},currentTrackEntity:s}))})),this.vkComPlayer.on(this,a.events.PLAY,(e=>{e&&(this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===u(e)||(this.state.currentTrackEntity=c(e,0)),this.updateState((0,i._)({},this.state,{status:"playing"})),this.mediaMediator.handlePlayerOn(this))})),this.vkComPlayer.on(this,a.events.PAUSE,(e=>{e&&(this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===u(e)||(this.state.currentTrackEntity=c(e,0)),this.updateState((0,i._)({},this.state,{status:"paused"})))})),this.vkComPlayer.on(this,[a.events.STOP,a.events.ENDED],(e=>{e&&(this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===u(e)||(this.state.currentTrackEntity=c(e,1)),this.updateState((0,i._)({},this.state,{status:"stopped"})))})),this.vkComPlayer.on(this,a.events.PROGRESS,((e,t)=>{if(!e||"number"!=typeof t)return;this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===u(e)||(this.state.currentTrackEntity=c(e,t)),"stopped"===this.state.status&&t&&(this.state.status="paused");const s=(0,i._)({},this.state),a=s.currentTrackEntity;this.updateState((0,i._)({},s,{currentTrackEntity:(0,i._)({},a,{audioTrack:(0,i._)({},a.audioTrack,{progress:t||0})})}))}))}}},356432:(e,t,s)=>{s.d(t,{ProxyStorage:()=>r});var i=s(11010),a=s(395340);class r{constructor(e){this.identify=e=>{this.storage.identify(e)},this.get=e=>"settings-sound-notifications-on"===e?!window.ls.get("sound_notify_off"):this.storage.get(e),this.set=(e,t)=>{"settings-sound-notifications-on"!==e?this.storage.set(e,t):window.ls.set("sound_notify_off",Number(!t))},this.del=e=>{"settings-sound-notifications-on"!==e?this.storage.del(e):window.ls.remove("sound_notify_off")};var t=this;this.getIDB=(0,i._)((function*(e){return t.storage.getIDB(e)}));var s=this;this.setIDB=(0,i._)((function*(e,t){s.storage.setIDB(e,t)}));var r=this;this.updateIDB=(0,i._)((function*(e,t){r.storage.updateIDB(e,t)}));var n=this;this.delIDB=(0,i._)((function*(e){n.storage.delIDB(e)})),this.storage=new a.Storage(e),this.dbName=e}}},485950:(e,t,s)=>{s.d(t,{SharedEngine:()=>a});var i=s(906e3);class a{constructor(e,t){if(this.logger=e,this.isMaster=t,this.queued={kind:"Buffer",buffer:[]},this.ts=0,this.pts=0,this.connect=e=>(this.ts=e.ts,this.pts=e.pts,this.engine.connect(e)),this.poll=()=>this.engine.poll(),this.isConnected=()=>this.engine.isConnected(),this.switch=e=>{if(this.broadcast)switch(this.logger.info("[SHARED ENGINE] switch to",e),e){case"master":if(this.isMaster)return;switch(this.queued.kind){case"Callback":this.queued.cancel();break;case"Buffer":this.queued.buffer=[]}return void(this.isMaster=!0);case"slave":if(!this.isMaster)return;return void(this.isMaster=!1)}},this.fetch=(e,t,s)=>Promise.resolve().then((()=>{if(!this.isMaster)return this.fetchSlave();const i="number"==typeof t.ts?t.ts:1/0;return this.logger.info("[SHARED ENIGNE]",this.ts,i),i>this.ts?Promise.resolve({failed:1}):this.fetchMaster(e,t,s)})).then((e=>("ts"in e&&(this.ts=e.ts,this.pts=e.pts),e))),this.fetchMaster=(e,t,s)=>{this.logger.info("[SHARED ENGINE] fetch master",e);const i=new Headers;i.append("Connection","keep-alive"),i.append("Content-Type","application/x-www-form-urlencoded");const a=Object.keys(t).reduce(((e,s)=>(void 0!==t[s]&&e.append(s,t[s]),e)),new URLSearchParams);return fetch(e,{method:"POST",signal:s,headers:i,body:a}).then((e=>{if(!e.ok)throw new Error(`ServerError ${e.status}`);return e.json()})).then((e=>{const t=this.ts;return setTimeout((()=>{this.broadcast&&this.broadcast({type:"updates",payload:{tsOld:t,data:e}})})),e}))},this.fetchSlave=()=>{if("Callback"===this.queued.kind)return Promise.reject(new Error("vkcom engine slave double fetch error"));this.logger.info("[SHARED ENGINE] fetch slave");const e=this.queued.buffer.shift(),t=e?Promise.resolve(e):new Promise((e=>{this.queued={kind:"Callback",push:t=>{this.queued={kind:"Buffer",buffer:[]},e(t)},cancel:()=>{this.queued={kind:"Buffer",buffer:[]},e({tsOld:this.ts,data:{ts:this.ts,pts:this.pts,updates:[]}})}}}));return t.then((e=>e.tsOld>this.ts?(this.queued={kind:"Buffer",buffer:[]},Promise.resolve({failed:1})):e.data))},this.engine=new i.Engine(this.logger,((...e)=>this.fetch(...e))),this.version=this.engine.version,void 0!==window.BroadcastChannel){const e=new BroadcastChannel("messenger-shared-engine");this.broadcast=t=>e.postMessage(t),e.onmessage=e=>{if("updates"===e.data.type){const t=e.data.payload;if(this.isMaster)return;if(this.logger.info("[SHARED ENGINE] broadcast received",t),!this.isConnected())return;return"Callback"===this.queued.kind?void this.queued.push(t):void this.queued.buffer.push(t)}this.logger.error("[SHARED ENGINE] Неизвестный бродкаст")}}}}},25153:(e,t,s)=>{s.d(t,{SharedQueue:()=>i});class i{connect(){if(this.isConnected())return;this.queued=this.empty();const e=window.Notifier.getEventQueueInstance();this.unsubscribe=e.subscribe((e=>{const t={kind:"Batch",ts:"1",events:[e]};if("Callback"===this.queued.kind){const e=this.queued.resolve;return this.queued=this.empty(),void e(t)}if(this.queued.buffer.length>=this.MAX_BUFFER_SIZE)return this.unsubscribe&&this.unsubscribe(),this.unsubscribe=null,void this.queued.buffer.push({kind:"Disconnected",reason:"backpressure"});this.queued.buffer.push(t)}))}constructor(){this.MAX_BUFFER_SIZE=50,this.unsubscribe=null,this.empty=()=>({kind:"Buffer",buffer:[]}),this.poll=()=>{if("Callback"===this.queued.kind)return this.queued.reject("Queue.poll вызван дважды!"),new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}}));const e=this.queued.buffer.shift();if(e)return Promise.resolve(e);if(!this.isConnected())throw new Error("Queue.connect еще не был вызван!");return new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}}))},this.disconnect=()=>{switch(this.unsubscribe&&this.unsubscribe(),this.unsubscribe=null,this.queued.kind){case"Callback":this.queued.resolve({kind:"Disconnected",reason:"manual"}),this.queued=this.empty();break;case"Buffer":this.queued.buffer.push({kind:"Disconnected",reason:"manual"});break;default:this.queued}},this.isConnected=()=>!!this.unsubscribe,this.queued=this.empty()}}},651695:(e,t,s)=>{s.d(t,{Stats:()=>l});var i=s(338386),a=s(999110),r=s(578137),n=s(235431),o=s(745163);class l{constructor(){this.init=()=>{},this.logEvent=e=>{!function(e){switch(e.type){case"type_action":{const t=e.type_action;switch(t.type){case"type_ab_custom_metrics_item":i.customMetricsCollector.logEvent(t.type_ab_custom_metrics_item);break;case"type_messaging_action_item":a.messagingActionItemStatCollector.logEvent(t.type_messaging_action_item);break;case"type_messaging_audio_message_item":r.audioMessageStatCollector.logEvent(t.type_messaging_audio_message_item);break;case"type_settings_changes_item":n.settingsChangesStatCollector.logEvent(t.type_settings_changes_item)}break}case"type_navgo":{const{screen:t,screen_to:s,destination_item:i}=e.type_navgo;o.navigationStat.sendGo(s||t,{destinationItem:i});break}}}(e)}}}},369379:(e,t,s)=>{s.d(t,{Settings:()=>w});s(252495);var i=s(667294),a=s(597298),r=s(803220),n=s(743597),o=s(778816),l=s(951891),c=s(284069),u=s(851594),d=s(19675),h=s(926128),m=s(538649),p=s(386835),g=s(315226),_=s(690839),v=s(141343),y=(s(354943),s(354819),s(86894)),f=s(696023),E=s(126528),S=(s(709646),s(895043)),C=s(163332),I=s(599660),k=s(95154);const w=({isLoading:e,set:t=new Set(["ctrSubmit","soundNotifications","showRecommendations","countOnlyNotMuted","autoUnarchive","transcriptAutoShow","theme","push"]),profileInfoControl:s})=>{const{lang:_,browserNotifications:v}=(0,f.useBrowserEnv)(),{settings:C}=(0,f.useViewer)(),I=(0,f.useFeatureFlags)(),w=(0,f.useDispatch)();return(0,S.useStatsOnMount)({type:"type_navgo",type_navgo:{screen:"settings",subtype:"go"}}),i.createElement("ul",{className:"Settings"},e&&i.createElement(E.OptimizedSpinner,{className:"Settings__loader"}),s&&i.createElement(r.OptionsListItemWrapper,{className:"Settings__profileOptionItem",isPadded:!1},s),t.has("ctrSubmit")&&i.createElement(r.OptionsListItem,{icon:i.createElement(n.Icon28SendCircleFillGray,null),title:_.use("me_settings_message_submit"),aside:i.createElement(b,{isCtrSubmitSelected:C.ctrSubmit,onChange:e=>w({type:"UserChangedSetting",setting:"ctrSubmit",value:e})})}),t.has("soundNotifications")&&i.createElement(r.OptionsListItem,{icon:i.createElement(o.Icon28VolumeCircleFillGray,null),title:_.use("me_settings_sound_notifications"),aside:i.createElement(y.Switch,{className:"Settings__switch",checked:C.soundNotifications,onChange:e=>w({type:"UserChangedSetting",setting:"soundNotifications",value:Boolean(e.target.checked)})})}),t.has("showRecommendations")&&i.createElement(r.OptionsListItem,{icon:i.createElement(l.Icon28UsersCircleFillGray,null),title:_.use("me_settings_show_recommendations"),aside:i.createElement(y.Switch,{className:"Settings__switch",checked:C.showRecommendations,onChange:e=>w({type:"UserChangedSetting",setting:"showRecommendations",value:Boolean(e.target.checked)})})}),t.has("countOnlyNotMuted")&&i.createElement(r.OptionsListItem,{icon:i.createElement(c.Icon28MessageUnreadCircleFillGray,null),title:_.use("me_settings_count_not_muted"),description:_.use("me_settings_count_not_muted_note"),aside:i.createElement(y.Switch,{className:"Settings__switch",checked:!C.countOnlyNotMuted,onChange:e=>w({type:"UserChangedSetting",setting:"countOnlyNotMuted",value:!Boolean(e.target.checked)})})}),t.has("autoUnarchive")&&i.createElement(r.OptionsListItem,{icon:i.createElement(u.Icon28ArchiveCircleFillGray,null),title:_.use("me_settings_auto_unarchive"),description:_.use("me_settings_auto_unarchive_note"),aside:i.createElement(y.Switch,{className:"Settings__switch",checked:C.autoUnarchive,onChange:e=>w({type:"UserChangedSetting",setting:"autoUnarchive",value:Boolean(e.target.checked)})})}),v&&i.createElement(r.OptionsListItem,{icon:i.createElement(d.Icon28NotificationCircleFillGray,null),title:_.use("me_settings_browser_notifications_messages_calls"),aside:i.createElement(T,{browserNotifications:v})}),C.teacherVerification&&i.createElement(r.OptionsListItem,{icon:i.createElement(h.Icon28EducationCircleFillGray,null),title:_.use("me_settings_teacher_verification_title"),description:_.use("me_settings_teacher_verification"),aside:i.createElement(a.ExternalLink,{href:k.SFERUM_VERIFICATION_LINK,className:"Settings__link"},_.use("me_settings_teacher_verification_link"))}),t.has("transcriptAutoShow")&&i.createElement(r.OptionsListItem,{icon:i.createElement(m.Icon28TextCircleFillGray,null),title:_.use("me_settings_auto_transcript"),aside:i.createElement(y.Switch,{className:"Settings__switch",checked:C.transcriptAutoShow,onChange:e=>w({type:"UserChangedSetting",setting:"transcriptAutoShow",value:Boolean(e.target.checked)})})}),I.vkm_reactions&&t.has("messageReactionAnimation")&&i.createElement(r.OptionsListItem,{icon:i.createElement(p.Icon16Stars,{fill:"var(--vkui--color_text_contrast)"}),hasIconBackground:!0,title:_.use("me_settings_message_reactions_animation"),aside:i.createElement(y.Switch,{className:"Settings__switch",checked:C.messageReactionAnimation,onChange:e=>w({type:"UserChangedSetting",setting:"messageReactionAnimation",value:Boolean(e.target.checked)})})}),I.vkm_reactions&&t.has("push")&&i.createElement(r.OptionsListItem,{icon:i.createElement(d.Icon28NotificationCircleFillGray,null),title:_.use("me_settings_reaction_notifications"),aside:i.createElement(y.Switch,{className:"Settings__switch",checked:C.push.messageReaction.isEnabled,onChange:e=>w({type:"UserChangedPushSetting",setting:"messageReaction",value:{isEnabled:Boolean(e.target.checked),withMessageText:!0}})})}),t.has("theme")&&i.createElement(r.OptionsListItem,{icon:i.createElement(g.Icon28SunglassesCircleFillGray,null),title:_.use("me_settings_theme"),aside:i.createElement(M,{theme:C.theme,onChange:e=>w({type:"SettingThemeUpdated",value:e})})}))},b=({isCtrSubmitSelected:e,onChange:t})=>{const{lang:s}=(0,f.useBrowserEnv)(),a=e?s.use("me_settings_message_submit_option_ctr"):s.use("me_settings_message_submit_option_default");return i.createElement("div",{className:"Settings__select"},i.createElement(C.Dropdown,{openType:"click",hideOnClick:!0,content:i.createElement(I.ActionsMenu,null,i.createElement(I.ActionsMenuAction,{onClick:()=>t(!1),title:s.use("me_settings_message_submit_option_default"),subtitle:s.use("me_settings_message_submit_option_default_note"),rightIcon:i.createElement(_.Icon24CheckCircleOn,{style:{width:"16px",height:"16px",visibility:e?"hidden":"visible"}}),type:"primary"}),i.createElement(I.ActionsMenuAction,{onClick:()=>t(!0),title:s.use("me_settings_message_submit_option_ctr"),subtitle:s.use("me_settings_message_submit_option_ctr_note"),rightIcon:i.createElement(_.Icon24CheckCircleOn,{style:{width:"16px",height:"16px",visibility:e?"visible":"hidden"}}),type:"primary"})),align:"center",position:"bottom"},i.createElement(y.Button,{mode:"tertiary",after:i.createElement(v.Icon12Dropdown,null)},a)))},T=({browserNotifications:e})=>{const t=(0,f.useDispatch)(),{settings:s}=(0,f.useViewer)(),{lang:a}=(0,f.useBrowserEnv)();return"external"===s.browserNotifications?i.createElement(y.Button,{mode:"tertiary",after:i.createElement(v.Icon12Dropdown,null),onClick:e.onExternal},a.use("me_settings_browser_notifications_external")):i.createElement(y.Switch,{className:"Settings__switch",checked:s.browserNotifications,onChange:s=>e.onChange(Boolean(s.target.checked)).then((e=>t({type:"UserChangedBrowserNotifications",value:e})))})},A=["light","dark","system"],M=({theme:e,onChange:t})=>{const{lang:s}=(0,f.useBrowserEnv)();return i.createElement("div",{className:"Settings__select"},i.createElement(C.Dropdown,{openType:"click",hideOnClick:!0,content:i.createElement(I.ActionsMenu,null,A.map((a=>i.createElement(I.ActionsMenuAction,{key:a,onClick:()=>t(a),title:s.use(`me_settings_theme_${a}`),rightIcon:i.createElement(_.Icon24CheckCircleOn,{style:{width:"16px",height:"16px",visibility:e===a?"visible":"hidden"}}),type:"primary"})))),align:"center",position:"top"},i.createElement(y.Button,{mode:"tertiary",after:i.createElement(v.Icon12Dropdown,null)},s.use(`me_settings_theme_${e}`))))}},640974:(e,t,s)=>{s.d(t,{SettingsApp:()=>d,VKCOMSettingsApp:()=>h});s(968641),s(81290);var i=s(667294),a=s(369379),r=s(682930),n=s(96190),o=(s(279262),s(635800)),l=s(635402),c=s(324247),u=s(364705);const d=({store:e,env:t,set:s})=>{const[l,c]=(0,i.useState)(e.getState());(0,i.useEffect)((()=>e.subscribe(c)),[e]);const u=0===l.convoConn.pts,d=n.safeGet(l.peers,l.viewer.id);return i.createElement(o.ErrorBoundary,{fallbackRender:()=>null,onError:e=>t.logger.error("[SettingsApp] Error",e)},i.createElement(r.Provider,{env:t,state:l,dispatch:e.dispatch,featureFlags:e.featureFlags,owner:d},i.createElement(a.Settings,{isLoading:u,set:s})))},h=({store:e,env:t})=>{const[s,a]=(0,i.useState)(e.getState());if((0,i.useEffect)((()=>e.subscribe(a)),[e]),"loading"===s.convoConn.status)return null;const l=n.safeGet(s.peers,s.viewer.id);return i.createElement(o.ErrorBoundary,{fallbackRender:()=>null,onError:e=>t.logger.error("[SettingsApp] Error",e)},i.createElement(r.Provider,{env:t,state:s,dispatch:e.dispatch,featureFlags:e.featureFlags,owner:l},i.createElement(m,{state:s})))},m=({state:e})=>{const{route:t}=(0,u.useRouter)();if("SettingsRoute"!==t.kind)return null;const s=t.section||"main";return i.createElement("div",{className:"VKCOMSettingsApp MEConfig"},i.createElement(c.VKCOMSettingsContent,{activeSection:s,convos:e.convos,locks:e.locks,folders:e.organisers.folders,recommendedFolders:e.organisers.recommendedFolders,foldersView:"horizontal"}),i.createElement(l.VKCOMSettingsMenu,{activeSection:s}))}},459357:(e,t,s)=>{s.d(t,{MarusiaMediaRecorder:()=>l});var i=s(280467);let a,r,n=window.AudioContext||window.webkitAudioContext;function o(e){let t=new Event("error");return t.data=new Error("Wrong state for "+e),t}class l{start(e){if("inactive"!==this.state)return this.em.dispatchEvent(o("start"));this.state="recording",a||(a=new n),this.clone=this.stream.clone(),this.input=a.createMediaStreamSource(this.clone),this.analyser=a.createAnalyser(),r||(r=a.createScriptProcessor(2048,1,1)),this.input.connect(this.analyser),this.analyser.connect(r),r.connect(a.destination);let t=this;t.encoder.postMessage(["init",a.sampleRate]),r.onaudioprocess=e=>{"recording"===t.state&&(this.onAudioProcessHandler(this.analyser),t.encoder.postMessage(["encode",e.inputBuffer.getChannelData(0)]))},this.input.connect(r),r.connect(a.destination),this.em.dispatchEvent(new Event("start")),e&&(this.slicing=setInterval((()=>{"recording"===t.state&&t.requestData()}),e))}stop(){return"inactive"===this.state?this.em.dispatchEvent(o("stop")):(this.requestData(),this.state="inactive",this.clone.getTracks().forEach((e=>{e.stop()})),this.encoder.terminate(),clearInterval(this.slicing))}pause(){return"recording"!==this.state?this.em.dispatchEvent(o("pause")):(this.state="paused",this.em.dispatchEvent(new Event("pause")))}resume(){return"paused"!==this.state?this.em.dispatchEvent(o("resume")):(this.state="recording",this.em.dispatchEvent(new Event("resume")))}requestData(){return"inactive"===this.state?this.em.dispatchEvent(o("requestData")):this.encoder.postMessage(["dump",a.sampleRate])}addEventListener(...e){this.em.addEventListener(...e)}removeEventListener(...e){this.em.removeEventListener(...e)}dispatchEvent(...e){this.em.dispatchEvent(...e)}constructor(e,t){this.stream=e,this.state="inactive",this.onAudioProcessHandler=t,this.em=document.createDocumentFragment(),this.encoder=function(e){let t=e.toString().replace(/^(\(\)\s*=>|function\s*\(\))\s*{/,"").replace(/}$/,""),s=new Blob([t]);return new Worker(URL.createObjectURL(s))}(l.encoder);let s=this;this.encoder.addEventListener("message",(e=>{let t=new Event("dataavailable");t.data=new Blob([e.data],{type:s.mimeType}),s.em.dispatchEvent(t),"inactive"===s.state&&s.em.dispatchEvent(new Event("stop"))}))}}l.prototype.mimeType="audio/wav",l.isTypeSupported=e=>l.prototype.mimeType===e,l.notSupported=!navigator.mediaDevices||!n,l.encoder=i.default},280467:(e,t,s)=>{s.d(t,{default:()=>i});const i=()=>{let e=[];onmessage=t=>{"encode"===t.data[0]?function(t){let s=t.length,i=new Uint8Array(2*s);for(let e=0;e<s;e++){let s=2*e,a=t[e];a>1?a=1:a<-1&&(a=-1),a*=32768,i[s]=a,i[s+1]=a>>8}e.push(i)}(t.data[1]):"dump"===t.data[0]&&function(t){let s=e.length?e[0].length:0,i=e.length*s,a=new Uint8Array(44+i),r=new DataView(a.buffer);r.setUint32(0,1380533830,!1),r.setUint32(4,36+i,!0),r.setUint32(8,1463899717,!1),r.setUint32(12,1718449184,!1),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,1,!0),r.setUint32(24,t,!0),r.setUint32(28,2*t,!0),r.setUint16(32,2,!0),r.setUint16(34,16,!0),r.setUint32(36,1684108385,!1),r.setUint32(40,i,!0);for(let t=0;t<e.length;t++)a.set(e[t],t*s+44);e=[],postMessage(a.buffer,[a.buffer])}(t.data[1])}}}}]);try{stManager.done("dist/0d56ad4cfaad4debed7a4eea81a4c426.304816fe61aaf41beefc.js")}catch(e){}